name: build_azerothcore

on:
  workflow_dispatch:
  schedule:
    - cron: 0 19 * * *

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # æ ¸å¿ƒé…ç½®å‚æ•°ï¼ˆé›†ä¸­ç®¡ç†ï¼‰
      ACORE_REPO: "https://github.com/liyunfan1223/azerothcore-wotlk.git"
      ACORE_BRANCH: "Playerbot"
      BUILD_TYPE: "MinSizeRel"
      MODULES_INPUT: |
        https://github.com/liyunfan1223/mod-playerbots.git master
        https://github.com/azerothcore/mod-eluna.git master
        https://github.com/azerothcore/mod-learn-spells.git master
        https://github.com/azerothcore/mod-autobalance.git master
        https://github.com/azerothcore/mod-auto-revive.git master
      MODULES_DIR: azerothcore/modules
      # è·¯å¾„é…ç½®
      INSTALL_DIR: azerothcore/install
      BUILD_DIR: azerothcore/build
      # æƒé™ç›¸å…³ï¼ˆéœ€åœ¨ä»“åº“ Settings -> Secrets ä¸­æ·»åŠ  RELEASE_TOKENï¼‰
      RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}

    steps:
      - name: æ£€æŸ¥æ¶æ„ï¼ˆä»…x86_64ï¼‰
        run: |
          [ "$(uname -m)" = "x86_64" ] || { 
            echo "âŒ ä»…æ”¯æŒx86_64æ¶æ„"; 
            exit 1; 
          }
          echo "âœ… ç¡®è®¤æ¶æ„ï¼šx86_64"

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y \
            git \
            cmake \
            make \
            gcc \
            g++ \
            clang \
            libmysqlclient-dev \
            libssl-dev \
            libbz2-dev \
            libreadline-dev \
            libncurses-dev \
            libboost-all-dev \
            libcurl4-openssl-dev \
            gh  # å®‰è£…GitHub CLIï¼ˆç”¨äºæ¸…ç†æ—§Releasesï¼‰

      - name: ç”Ÿæˆæ—¶é—´æˆ³
        id: ts
        run: |
          echo "utc=$(date -u +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
          echo "sh=$(TZ='Asia/Shanghai' date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: å…‹éš†æ ¸å¿ƒä»“åº“
        run: |
          echo "ğŸ”§ å…‹éš†ä»“åº“ï¼š$ACORE_REPOï¼ˆåˆ†æ”¯ï¼š$ACORE_BRANCHï¼‰"
          git clone \
            --depth 1 \
            --branch "$ACORE_BRANCH" \
            "$ACORE_REPO" \
            azerothcore
          cd azerothcore && git submodule update --init --recursive

      - name: æ‹‰å–æ¨¡å—
        id: modules
        run: |
          mkdir -p "$MODULES_DIR"
          success=()
          failure=()
          
          echo "ğŸ“¦ å¤„ç†æ¨¡å—åˆ—è¡¨..."
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | awk '{print $1}')
            branch=$(echo "$line" | awk '{print $2}')
            name=$(basename "$repo" .git)
            path="$MODULES_DIR/$name"
            
            if git clone \
              --depth 1 \
              --branch "$branch" \
              "$repo" \
              "$path"; then
              success+=("$nameï¼ˆ$branchï¼‰")
            else
              failure+=("$nameï¼ˆ$branchï¼‰")
              echo "âš ï¸ æ¨¡å— $name æ‹‰å–å¤±è´¥"
            fi
          done <<< "$MODULES_INPUT"
          
          echo "success=$(IFS=';'; echo "${success[*]}")" >> $GITHUB_OUTPUT
          echo "failure=$(IFS=';'; echo "${failure[*]}")" >> $GITHUB_OUTPUT

      - name: é…ç½®CMake
        run: |
          mkdir -p "$BUILD_DIR" && cd "$BUILD_DIR"
          cmake ../ \
            -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR" \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DWITH_WARNINGS=1 \
            -DTOOLS_BUILD=all \
            -DSCRIPTS=static \
            -DMODULES=static

      - name: ç¼–è¯‘å®‰è£…
        run: |
          cd "$BUILD_DIR"
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆ$(nproc)æ ¸å¿ƒï¼‰"
          make -j$(nproc) && make install

      - name: æ‰“åŒ…äº§ç‰©
        id: package
        run: |
          tar -czvf \
            acore-${{ steps.ts.outputs.utc }}.tar.gz \
            -C "$BUILD_DIR" .
          echo "name=acore-${{ steps.ts.outputs.utc }}.tar.gz" >> $GITHUB_OUTPUT

      - name: ä¿å­˜äº§ç‰©åˆ°Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.name }}
          path: ${{ steps.package.outputs.name }}
          retention-days: 3

      - name: ä¸Šä¼ äº§ç‰©åˆ°Releases
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ env.RELEASE_TOKEN }}  # ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„æƒé™ä»¤ç‰Œ
          tag_name: build-${{ steps.ts.outputs.utc }}
          name: æ¯å¤©è‡ªåŠ¨æ„å»º ${{ steps.ts.outputs.sh }}
          body: |
            ### Azerothcore-Wotlk For Linux X86-64ï¼ˆ${{ steps.ts.outputs.sh }}ï¼‰
            - æ ¸å¿ƒåˆ†æ”¯ï¼š${{ env.ACORE_BRANCH }}
            - é›†æˆæ¨¡å—ï¼š${{ steps.modules.outputs.success }}
            - å¤±è´¥æ¨¡å—ï¼š${{ steps.modules.outputs.failure || 'æ— ' }}
            - æ•°æ®æ–‡ä»¶ï¼šæš‚æœªæä¾› ï¼ˆmapã€mmapã€dbcã€vmapã€Camerasï¼‰
          files: ${{ steps.package.outputs.name }}
          draft: false
          prerelease: false

      - name: æ¸…ç†æ—§Releasesï¼ˆä¿ç•™æœ€æ–°3ä»½ï¼‰
        run: |
          # é…ç½®GitHub CLIä½¿ç”¨æŒ‡å®šä»¤ç‰Œ
          echo "${{ env.RELEASE_TOKEN }}" | gh auth login --with-token
          
          # è·å–ä»“åº“ä¿¡æ¯ï¼ˆä»ç¯å¢ƒå˜é‡è‡ªåŠ¨è·å–å½“å‰ä»“åº“ï¼‰
          repo_full_name=$(gh repo view --json nameWithOwner --jq .nameWithOwner)
          
          # è·å–æ‰€æœ‰Releases IDï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œæœ€æ–°åœ¨å‰ï¼‰
          releases=$(gh api repos/$repo_full_name/releases | jq -r '.[] | .id')
          release_ids=($releases)
          echo "å…±æ‰¾åˆ° ${#release_ids[@]} ä¸ªReleasesï¼Œä¿ç•™æœ€æ–°3ä¸ªï¼Œåˆ é™¤å…¶ä½™..."
          
          # ä»ç¬¬4ä¸ªå¼€å§‹åˆ é™¤
          for ((i=3; i<${#release_ids[@]}; i++)); do
            id=${release_ids[$i]}
            echo "åˆ é™¤æ—§Release: $id"
            gh api -X DELETE repos/$repo_full_name/releases/$id
          done
