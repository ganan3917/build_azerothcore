name: ğŸ—ï¸ AzerothCore ç¼–è¯‘å·¥ä½œæµ

on:
  # æ‰‹åŠ¨è§¦å‘ï¼ˆä¿ç•™ï¼‰
  workflow_dispatch:
    inputs:
      build_type:
        description: 'ç¼–è¯‘ç±»å‹ (Release/Debug)'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Debug
  # å®šæ—¶è§¦å‘ï¼šåŒ—äº¬æ—¶é—´æ¯å¤©å‡Œæ™¨3ç‚¹ï¼ˆUTCæ—¶é—´19ç‚¹ï¼ŒUTC+8=åŒ—äº¬æ—¶é—´ï¼‰
  schedule:
    - cron: '0 19 * * *'  # cronæ ¼å¼ï¼šåˆ† æ—¶ æ—¥ æœˆ æ˜ŸæœŸï¼ˆUTCæ—¶é—´ï¼‰

env:
  # æ ¸å¿ƒå‚æ•°é…ç½®ï¼ˆä¿æŒä¸å˜ï¼‰
  AZEROTHCORE_REPO: "https://github.com/azerothcore/azerothcore-wotlk.git"
  AZEROTHCORE_BRANCH: "master"
  MODULES: "https://github.com/azerothcore/mod-ah-bot.git,https://github.com/azerothcore/mod-eluna.git"
  ARCHITECTURE: "x64"
  BUILD_DIR: "${{ github.workspace }}/build"
  SOURCE_DIR: "${{ github.workspace }}/azerothcore"
  MODULES_DIR: "${{ github.workspace }}/azerothcore/modules"

jobs:
  compile-azerothcore:
    name: ğŸš€ ç¼–è¯‘ AzerothCore (${{ env.ARCHITECTURE }})
    runs-on: ubuntu-22.04
    steps:
      - name: ğŸ“‹ æ£€æŸ¥ç³»ç»Ÿä¿¡æ¯
        run: |
          echo "ğŸ’» æ“ä½œç³»ç»Ÿ: $(lsb_release -d | cut -f2)"
          echo "ğŸ”§ å†…æ ¸ç‰ˆæœ¬: $(uname -r)"
          echo "ğŸ§® å¤„ç†å™¨: $(grep -c ^processor /proc/cpuinfo) æ ¸å¿ƒ"
          echo "ğŸ’¾ å†…å­˜: $(free -h | awk '/^Mem:/ {print $2}')"
        shell: bash

      - name: ğŸ› ï¸ å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ”„ æ›´æ–°ç³»ç»ŸåŒ…åˆ—è¡¨..."
          sudo apt update -qq
          
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo apt install -y -qq \
            build-essential \
            cmake \
            git \
            clang \
            libssl-dev \
            libbz2-dev \
            libreadline-dev \
            libncurses-dev \
            libboost-all-dev \
            mysql-server \
            libmysqlclient-dev \
            libace-6.* \
            libace-dev
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        shell: bash
        continue-on-error: false

      - name: ğŸ“¥ å…‹éš† AzerothCore ä»“åº“
        run: |
          echo "ğŸ”— ä»“åº“åœ°å€: ${{ env.AZEROTHCORE_REPO }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ env.AZEROTHCORE_BRANCH }}"
          
          git clone --branch ${{ env.AZEROTHCORE_BRANCH }} \
                    --depth 1 \
                    ${{ env.AZEROTHCORE_REPO }} \
                    ${{ env.SOURCE_DIR }}
          
          echo "âœ… ä»“åº“å…‹éš†å®Œæˆ"
        shell: bash

      - name: ğŸ§© å®‰è£…æ¨¡å—
        run: |
          echo "ğŸ“¦ æ¨¡å—åˆ—è¡¨: ${{ env.MODULES }}"
          IFS=',' read -ra MOD_ARRAY <<< "${{ env.MODULES }}"
          
          mkdir -p ${{ env.MODULES_DIR }}
          
          for mod in "${MOD_ARRAY[@]}"; do
            mod_name=$(basename "$mod" .git)
            echo "ğŸ”½ å…‹éš†æ¨¡å—: $mod_name"
            git clone --depth 1 "$mod" "${{ env.MODULES_DIR }}/$mod_name"
          done
          
          echo "âœ… æ‰€æœ‰æ¨¡å—å®‰è£…å®Œæˆ"
        shell: bash
        if: env.MODULES != ''

      - name: ğŸ”§ é…ç½® CMake
        run: |
          echo "ğŸ“ åˆ›å»ºç¼–è¯‘ç›®å½•: ${{ env.BUILD_DIR }}"
          mkdir -p ${{ env.BUILD_DIR }}
          cd ${{ env.BUILD_DIR }}
          
          echo "âš™ï¸ é…ç½® CMake é€‰é¡¹..."
          cmake ../azerothcore \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/azerothcore-install \
            -DCMAKE_BUILD_TYPE=${{ github.event.inputs.build_type || 'Release' }} \  # å®šæ—¶ä»»åŠ¡é»˜è®¤ç”¨Release
            -Dazerothcore_PLATFORM=${{ env.ARCHITECTURE }} \
            -DENABLE_MYSQL_SSL=ON \
            -DTOOLS_BUILD=all \
            -DSCRIPTS=static
          
          echo "âœ… CMake é…ç½®å®Œæˆ"
        shell: bash

      - name: ğŸ”¨ ç¼–è¯‘æºä»£ç 
        run: |
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ (${{ github.event.inputs.build_type || 'Release' }})..."
          cd ${{ env.BUILD_DIR }}
          
          # ä½¿ç”¨å¤šçº¿ç¨‹åŠ é€Ÿç¼–è¯‘
          make -j $(nproc)
          
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘ç»“æœ..."
          make install
          
          echo "âœ… ç¼–è¯‘å®Œæˆ"
        shell: bash

      - name: ğŸ“Š æ˜¾ç¤ºç¼–è¯‘ç»“æœ
        run: |
          echo "ğŸ“ å®‰è£…ç›®å½•: ${{ github.workspace }}/azerothcore-install"
          echo "ğŸ—‚ï¸ æœåŠ¡å™¨æ–‡ä»¶åˆ—è¡¨:"
          ls -lh ${{ github.workspace }}/azerothcore-install/bin/
          
          echo -e "\nğŸ“Š ç¼–è¯‘ç»Ÿè®¡:"
          echo "âœ… æ ¸å¿ƒäºŒè¿›åˆ¶æ–‡ä»¶å¤§å°:"
          du -sh ${{ github.workspace }}/azerothcore-install/bin/*server
        shell: bash

      - name: ğŸ“¦ æ‰“åŒ…ç¼–è¯‘ç»“æœ
        run: |
          echo "ğŸ“¦ æ‰“åŒ…å®‰è£…æ–‡ä»¶..."
          cd ${{ github.workspace }}
          tar -czf azerothcore-${{ env.ARCHITECTURE }}-${{ github.event.inputs.build_type || 'Release' }}.tar.gz azerothcore-install/
          
          echo "âœ… æ‰“åŒ…å®Œæˆ"
        shell: bash

      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: azerothcore-build-${{ env.ARCHITECTURE }}-${{ github.event.inputs.build_type || 'Release' }}
          path: ${{ github.workspace }}/azerothcore-*.tar.gz
          retention-days: 7
