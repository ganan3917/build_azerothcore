name: ç¼–è¯‘AzerothCore-WoTLK (x86-64)

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ + è‡ªåŠ¨è§¦å‘ï¼ˆæ¨é€åˆ°æŒ‡å®šåˆ†æ”¯æ—¶ï¼‰
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ”¯æŒè¾“å…¥å‚æ•°ï¼‰
    inputs:
      acore_repo:
        description: "AzerothCoreä»“åº“åœ°å€"
        required: true
        default: "https://github.com/azerothcore/azerothcore-wotlk.git"
        type: string
      acore_branch:
        description: "AzerothCoreåˆ†æ”¯"
        required: true
        default: "master"
        type: string
      modules:
        description: "æ¨¡å—åˆ—è¡¨ï¼ˆæ ¼å¼ï¼šä»“åº“URL:åˆ†æ”¯,ä»“åº“URL2:åˆ†æ”¯2ï¼Œç©ºåˆ™ä¸å®‰è£…ï¼‰"
        required: false
        default: " "
        type: string
      build_type:
        description: "ç¼–è¯‘ç±»å‹"
        required: true
        default: "RelWithDebInfo"
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
          - MinSizeRel
  push:  # è‡ªåŠ¨è§¦å‘ï¼ˆæ¨é€åˆ°mainåˆ†æ”¯æ—¶ï¼‰
    branches: ["main"]


jobs:
  build:
    runs-on: ubuntu-22.04  # Linux x86-64ç¯å¢ƒ
    steps:
      - name: æ£€æŸ¥ç³»ç»Ÿæ¶æ„
        run: |
          if [ "$(uname -m)" != "x86_64" ]; then
            echo "âŒ å¿…é¡»åœ¨x86_64æ¶æ„ä¸Šç¼–è¯‘"
            exit 1
          fi
          echo "âœ… ç¡®è®¤ç³»ç»Ÿæ¶æ„ï¼šx86_64"

      - name: å®‰è£…ä¾èµ–ï¼ˆå®˜æ–¹æ¨èç‰ˆæœ¬ï¼‰
        run: |
          sudo apt update -y
          # åŸºç¡€ç¼–è¯‘å·¥å…·
          sudo apt install -y build-essential gcc g++ make cmake git
          # åº“ä¾èµ–ï¼ˆå‚è€ƒAzerothCoreå®˜æ–¹æ–‡æ¡£ï¼‰
          sudo apt install -y libssl-dev libbz2-dev libreadline-dev libncurses-dev \
            libmariadbclient-dev-compat zlib1g-dev libboost-all-dev
          # æ£€æŸ¥cmakeç‰ˆæœ¬ï¼ˆéœ€3.16+ï¼‰
          cmake --version

      - name: å…‹éš†AzerothCoreä»“åº“
        run: |
          # ä»è¾“å…¥å‚æ•°æˆ–é»˜è®¤å€¼è·å–ä»“åº“å’Œåˆ†æ”¯ï¼ˆè‡ªåŠ¨è§¦å‘æ—¶ç”¨é»˜è®¤å€¼ï¼‰
          REPO="${{ github.event.inputs.acore_repo || 'https://github.com/azerothcore/azerothcore-wotlk.git' }}"
          BRANCH="${{ github.event.inputs.acore_branch || 'master' }}"
          
          echo "ğŸ”§ å…‹éš†ä»“åº“ï¼š$REPOï¼ˆåˆ†æ”¯ï¼š$BRANCHï¼‰"
          git clone --depth 1 --branch "$BRANCH" "$REPO" azerothcore
          cd azerothcore
          # æ‹‰å–å­æ¨¡å—ï¼ˆæ ¸å¿ƒä¾èµ–ï¼‰
          git submodule update --init --recursive

      - name: æ‹‰å–æŒ‡å®šæ¨¡å—ï¼ˆè‹¥æœ‰ï¼‰
        run: |
          # ä»è¾“å…¥å‚æ•°è·å–æ¨¡å—åˆ—è¡¨ï¼ˆè‡ªåŠ¨è§¦å‘æ—¶ç”¨é»˜è®¤å€¼ï¼‰
          MODULES="${{ github.event.inputs.modules || 'https://github.com/azerothcore/mod-ah-bot:master,https://github.com/azerothcore/mod-transmog:master' }}"
          
          if [ -z "$MODULES" ]; then
            echo "â„¹ï¸ æœªæŒ‡å®šæ¨¡å—ï¼Œè·³è¿‡æ‹‰å–"
            exit 0
          fi
          
          # æ¨¡å—éœ€æ”¾åœ¨src/modulesç›®å½•ï¼ˆAzerothCoreé»˜è®¤æ‰«æè·¯å¾„ï¼‰
          MODULE_DIR="azerothcore/src/modules"
          mkdir -p "$MODULE_DIR"
          
          # è§£ææ¨¡å—åˆ—è¡¨ï¼ˆæ ¼å¼ï¼šURL:åˆ†æ”¯ï¼‰
          IFS=',' read -ra MOD_LIST <<< "$MODULES"
          for MOD in "${MOD_LIST[@]}"; do
            if [ -z "$MOD" ]; then continue; fi
            # æ‹†åˆ†URLå’Œåˆ†æ”¯
            MOD_URL=$(echo "$MOD" | cut -d':' -f1)
            MOD_BRANCH=$(echo "$MOD" | cut -d':' -f2)
            MOD_NAME=$(basename "$MOD_URL" .git)  # ç”¨ä»“åº“åä½œä¸ºæ¨¡å—ç›®å½•å
            
            echo "ğŸ”§ æ‹‰å–æ¨¡å—ï¼š$MOD_NAMEï¼ˆåˆ†æ”¯ï¼š$MOD_BRANCHï¼‰"
            git clone --depth 1 --branch "$MOD_BRANCH" "$MOD_URL" "$MODULE_DIR/$MOD_NAME"
          done

      - name: é…ç½®CMake
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'RelWithDebInfo' }}"
          mkdir -p azerothcore/build && cd azerothcore/build
          
          # æ ¸å¿ƒç¼–è¯‘é…ç½®ï¼ˆå‚è€ƒå®˜æ–¹æ¨èå‚æ•°ï¼‰
          cmake .. \
            -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DCMAKE_INSTALL_PREFIX=../install \  # å®‰è£…è·¯å¾„
            -DTOOLS=1 \                         # ç¼–è¯‘å·¥å…·ï¼ˆåœ°å›¾æå–ç­‰ï¼‰
            -DSCRIPTS=1 \                       # ç¼–è¯‘è„šæœ¬
            -DMODULES=1 \                       # å¯ç”¨æ¨¡å—æ”¯æŒ
            -DCMAKE_C_COMPILER=gcc \            # æŒ‡å®šCç¼–è¯‘å™¨
            -DCMAKE_CXX_COMPILER=g++ \          # æŒ‡å®šC++ç¼–è¯‘å™¨
            -DBUILD_SHARED_LIBS=OFF             # é™æ€é“¾æ¥ï¼ˆå‡å°‘è¿è¡Œæ—¶ä¾èµ–ï¼‰

      - name: ç¼–è¯‘é¡¹ç›®
        run: |
          cd azerothcore/build
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆä½¿ç”¨$(nproc)ä¸ªCPUæ ¸å¿ƒï¼‰"
          make -j$(nproc)  # å¤šçº¿ç¨‹ç¼–è¯‘
          make install     # å®‰è£…åˆ°æŒ‡å®šç›®å½•

      - name: æ‰“åŒ…ç¼–è¯‘ç»“æœ
        run: |
          # å‹ç¼©å®‰è£…ç›®å½•ï¼ˆåŒ…å«å¯æ‰§è¡Œæ–‡ä»¶ã€é…ç½®ç­‰ï¼‰
          cd azerothcore
          tar -czvf ../acore-build-${{ github.sha }}.tar.gz install/
          echo "ğŸ“¦ ç¼–è¯‘äº§ç‰©å·²æ‰“åŒ…ï¼šacore-build-${{ github.sha }}.tar.gz"

      - name: ä¸Šä¼ ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: acore-build-${{ github.sha }}
          path: acore-build-${{ github.sha }}.tar.gz
          retention-days: 14  # äº§ç‰©ä¿ç•™14å¤©
