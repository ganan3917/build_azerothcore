name: ç¼–è¯‘AzerothCoreå¹¶è¾“å‡ºåˆ°Annotations

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ + æ¨é€åˆ°mainåˆ†æ”¯è‡ªåŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      acore_repo:
        description: "AzerothCoreä»“åº“åœ°å€"
        required: true
        default: "https://github.com/azerothcore/azerothcore-wotlk.git"
        type: string
      acore_branch:
        description: "AzerothCoreåˆ†æ”¯"
        required: true
        default: "master"
        type: string
      build_type:
        description: "ç¼–è¯‘ç±»å‹"
        required: true
        default: "MinSizeRel"
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
          - MinSizeRel
  push:
    branches: ["main"]

jobs:
  build-and-annotate:
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€æŸ¥ç³»ç»Ÿæ¶æ„ï¼ˆç¡®ä¿x86-64ï¼‰
        run: |
          if [ "$(uname -m)" != "x86_64" ]; then
            echo "âŒ ä»…æ”¯æŒx86_64æ¶æ„"
            exit 1
          fi
          echo "âœ… ç¡®è®¤æ¶æ„ï¼šx86_64"

      - name: å®‰è£…ä¾èµ–ï¼ˆå®˜æ–¹æ¨èï¼‰
        run: |
          sudo apt update -y
          sudo apt install -y git cmake make gcc g++ clang libmysqlclient-dev libssl-dev \
            libbz2-dev libreadline-dev libncurses-dev libboost-all-dev libcurl4-openssl-dev

      - name: å®šä¹‰æ—¶é—´æˆ³å˜é‡ï¼ˆç”¨äºå‘½åï¼‰
        id: timestamp
        run: echo "TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: å…‹éš†AzerothCoreä»“åº“
        run: |
          REPO="${{ github.event.inputs.acore_repo || 'https://github.com/azerothcore/azerothcore-wotlk.git' }}"
          BRANCH="${{ github.event.inputs.acore_branch || 'master' }}"
          echo "ğŸ”§ å…‹éš†ä»“åº“ï¼š$REPOï¼ˆåˆ†æ”¯ï¼š$BRANCHï¼‰"
          git clone --depth 1 --branch "$BRANCH" "$REPO" azerothcore
          cd azerothcore
          git submodule update --init --recursive

      - name: é…ç½®CMake
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'RelWithDebInfo' }}"
          mkdir -p azerothcore/build && cd azerothcore/build
          cmake ../ -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DCMAKE_C_COMPILER=/usr/bin/clang \
            -DCMAKE_CXX_COMPILER=/usr/bin/clang++ \
            -DBUILD_SHARED_LIBS=OFF \
            -DWITH_WARNINGS=1 \
            -DTOOLS_BUILD=all \
            -DSCRIPTS=static \
            -DMODULES=static

      - name: ç¼–è¯‘é¡¹ç›®
        run: |
          cd azerothcore/build
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆä½¿ç”¨$(nproc)æ ¸å¿ƒï¼‰"
          make -j$(nproc)
          make install

      - name: æ‰“åŒ…ç¼–è¯‘ç»“æœï¼ˆæ—¶é—´æˆ³å‘½åï¼‰
        id: package
        run: |
          TIMESTAMP="${{ steps.timestamp.outputs.TIMESTAMP }}"
          # æ‰“åŒ…å®‰è£…ç›®å½•
          tar -czvf acore-build-${TIMESTAMP}.tar.gz -C azerothcore/install .
          # è·å–åŒ…å¤§å°ï¼ˆç”¨äºAnnotationsï¼‰
          PACKAGE_SIZE=$(du -h acore-build-${TIMESTAMP}.tar.gz | awk '{print $1}')
          echo "PACKAGE_NAME=acore-build-${TIMESTAMP}.tar.gz" >> $GITHUB_OUTPUT
          echo "PACKAGE_SIZE=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆï¼šacore-build-${TIMESTAMP}.tar.gzï¼ˆå¤§å°ï¼š$PACKAGE_SIZEï¼‰"

      - name: è¾“å‡ºç¼–è¯‘ç»“æœåˆ°Annotations
        run: |
          # GitHub Annotationsæ ¼å¼ï¼š::notice|warning|error file=è·¯å¾„,line=è¡Œå·::æ¶ˆæ¯ï¼ˆæ”¯æŒMarkdownï¼‰
          echo "::notice title=ç¼–è¯‘äº§ç‰©ä¿¡æ¯::" >&2
          echo "::notice::ğŸ“¦ äº§ç‰©åç§°ï¼š${{ steps.package.outputs.PACKAGE_NAME }}" >&2
          echo "::notice::ğŸ“Š äº§ç‰©å¤§å°ï¼š${{ steps.package.outputs.PACKAGE_SIZE }}" >&2
          echo "::notice::ğŸ”— ç¼–è¯‘æ¥æºï¼š${{ github.event.inputs.acore_repo || 'https://github.com/azerothcore/azerothcore-wotlk.git' }}ï¼ˆåˆ†æ”¯ï¼š${{ github.event.inputs.acore_branch || 'master' }}ï¼‰" >&2
          echo "::notice::ğŸ”¨ ç¼–è¯‘ç±»å‹ï¼š${{ github.event.inputs.build_type || 'RelWithDebInfo' }}" >&2
          echo "::notice::â° ç¼–è¯‘æ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')" >&2
        # æ³¨æ„ï¼šAnnotationséœ€è¦è¾“å‡ºåˆ°stderrï¼ˆ>&2ï¼‰æ‰èƒ½è¢«GitHubè¯†åˆ«

      # å¯é€‰ï¼šå°†äº§ç‰©ä¿å­˜ä¸ºå·¥ä½œæµArtifactï¼ˆæ–¹ä¾¿ä¸‹è½½ï¼‰
      - name: ä¿å­˜äº§ç‰©ä¸ºArtifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.PACKAGE_NAME }}
          path: ${{ steps.package.outputs.PACKAGE_NAME }}
          retention-days: 7  # ä¿ç•™7å¤©
