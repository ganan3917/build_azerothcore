name: ç¼–è¯‘AzerothCoreå¹¶å‘å¸ƒåˆ°Releases

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ + æ¨é€åˆ°mainåˆ†æ”¯è‡ªåŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      acore_repo:
        description: "AzerothCoreä»“åº“åœ°å€"
        required: true
        default: "https://github.com/azerothcore/azerothcore-wotlk.git"
        type: string
      acore_branch:
        description: "AzerothCoreåˆ†æ”¯"
        required: true
        default: "master"
        type: string
      build_type:
        description: "ç¼–è¯‘ç±»å‹"
        required: true
        default: "RelWithDebInfo"
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
          - MinSizeRel
  push:
    branches: ["main"]

# æƒé™é…ç½®ï¼ˆå…è®¸åˆ›å»º/åˆ é™¤Releasesï¼‰
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€æŸ¥ç³»ç»Ÿæ¶æ„ï¼ˆç¡®ä¿x86-64ï¼‰
        run: |
          if [ "$(uname -m)" != "x86_64" ]; then
            echo "âŒ ä»…æ”¯æŒx86_64æ¶æ„"
            exit 1
          fi
          echo "âœ… ç¡®è®¤æ¶æ„ï¼šx86_64"

      - name: å®‰è£…ä¾èµ–ï¼ˆå®˜æ–¹æ¨èï¼‰
        run: |
          sudo apt update -y
          # ç§»é™¤ä¸å¿…è¦çš„mysql-serverï¼Œä»…ä¿ç•™å®¢æˆ·ç«¯å¼€å‘åº“
          sudo apt install -y git cmake make gcc g++ clang libmysqlclient-dev libssl-dev \
            libbz2-dev libreadline-dev libncurses-dev libboost-all-dev libcurl4-openssl-dev
          # å®‰è£…GitHub CLIï¼ˆç”¨äºç®¡ç†Releasesï¼‰
          type -p curl >/dev/null || sudo apt install curl -y
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update -y && sudo apt install gh -y

      - name: å®šä¹‰æ—¶é—´æˆ³å˜é‡ï¼ˆç”¨äºå‘½åï¼‰
        id: timestamp
        run: echo "TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: å…‹éš†AzerothCoreä»“åº“
        run: |
          REPO="${{ github.event.inputs.acore_repo || 'https://github.com/azerothcore/azerothcore-wotlk.git' }}"
          BRANCH="${{ github.event.inputs.acore_branch || 'master' }}"
          echo "ğŸ”§ å…‹éš†ä»“åº“ï¼š$REPOï¼ˆåˆ†æ”¯ï¼š$BRANCHï¼‰"
          git clone --depth 1 --branch "$BRANCH" "$REPO" azerothcore
          cd azerothcore
          git submodule update --init --recursive

      - name: é…ç½®CMake
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'RelWithDebInfo' }}"
          mkdir -p azerothcore/build && cd azerothcore/build
          # ä¿®å¤CMakeå‚æ•°é”™è¯¯ï¼ˆè¡¥å……-Då‰ç¼€ï¼Œä¿®æ­£SCRIPTSæ‹¼å†™ï¼‰
          cmake ../ -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DCMAKE_C_COMPILER=/usr/bin/clang \
            -DCMAKE_CXX_COMPILER=/usr/bin/clang++ \
            -DBUILD_SHARED_LIBS=OFF \
            -DWITH_WARNINGS=1 \
            -DTOOLS_BUILD=all \
            -DSCRIPTS=static \
            -DMODULES=static

      - name: ç¼–è¯‘é¡¹ç›®
        run: |
          cd azerothcore/build
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆä½¿ç”¨$(nproc)æ ¸å¿ƒï¼‰"
          make -j$(nproc)
          make install

      - name: æ‰“åŒ…ç¼–è¯‘ç»“æœï¼ˆæ—¶é—´æˆ³å‘½åï¼‰
        run: |
          TIMESTAMP="${{ steps.timestamp.outputs.TIMESTAMP }}"
          # æ‰“åŒ…å®‰è£…ç›®å½•ï¼ˆåŒ…å«å¯æ‰§è¡Œæ–‡ä»¶ã€é…ç½®ã€å·¥å…·ç­‰ï¼‰
          tar -czvf acore-build-${TIMESTAMP}.tar.gz -C azerothcore/install .
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆï¼šacore-build-${TIMESTAMP}.tar.gz"

      - name: åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ äº§ç‰©
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TIMESTAMP="${{ steps.timestamp.outputs.TIMESTAMP }}"
          REPO_BRANCH="${{ github.event.inputs.acore_branch || 'master' }}"
          REPO_URL="${{ github.event.inputs.acore_repo || 'https://github.com/azerothcore/azerothcore-wotlk.git' }}"
          # åˆ›å»ºReleaseæ ‡ç­¾ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
          TAG="build-${TIMESTAMP}"
          # å‘å¸ƒæè¿°ï¼ˆä½¿ç”¨æ ‡å‡†Markdownæ¢è¡Œï¼‰
          DESCRIPTION="è‡ªåŠ¨ç¼–è¯‘äº $(date +'%Y-%m-%d %H:%M:%S')\n\nä»“åº“: $REPO_URL\nåˆ†æ”¯: $REPO_BRANCH\nç¼–è¯‘ç±»å‹: ${{ github.event.inputs.build_type || 'RelWithDebInfo' }}"
          # åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ‰“åŒ…æ–‡ä»¶
          gh release create "$TAG" \
            --title "AzerothCore ç¼–è¯‘äº§ç‰© ${TIMESTAMP}" \
            --body "$DESCRIPTION" \
            --prerelease \
            acore-build-${TIMESTAMP}.tar.gz

      - name: æ¸…ç†æ—§Releasesï¼ˆä»…ä¿ç•™æœ€æ–°5ä¸ªï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # åˆ—å‡ºæ‰€æœ‰Releasesï¼ˆæŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œæœ€æ–°åœ¨å‰ï¼‰ï¼Œå–ç¬¬6ä¸ªåŠä»¥åçš„æ ‡ç­¾
          OLD_TAGS=$(gh release list --exclude-drafts --limit 100 --json tagName --jq '.[5:].tagName | select(. != null)')
          # å¾ªç¯åˆ é™¤æ—§ç‰ˆæœ¬
          while IFS= read -r TAG; do
            if [ -n "$TAG" ]; then
              echo "ğŸ—‘ï¸ åˆ é™¤æ—§ç‰ˆæœ¬ï¼š$TAG"
              gh release delete "$TAG" --yes
              # åˆ é™¤å¯¹åº”çš„gitæ ‡ç­¾
              git push origin --delete "$TAG"
            fi
          done <<< "$OLD_TAGS"
