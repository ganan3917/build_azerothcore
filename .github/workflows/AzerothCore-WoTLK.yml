name: ç¼–è¯‘AzerothCoreå¹¶è¾“å‡ºåˆ°Annotations

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ + æ¨é€åˆ°mainåˆ†æ”¯ + ä¸Šæµ·æ—¶é—´æ¯å¤©å‡Œæ™¨3ç‚¹è‡ªåŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      acore_repo:
        description: "AzerothCoreä»“åº“åœ°å€"
        required: true
        # ã€ä¿®æ”¹1ã€‘é»˜è®¤ä»“åº“æ”¹ä¸º liyunfan1223/azerothcore-wotlk.git
        default: "https://github.com/liyunfan1223/azerothcore-wotlk.git"
        type: string
      acore_branch:
        description: "AzerothCoreåˆ†æ”¯"
        required: true
        # ã€ä¿®æ”¹2ã€‘é»˜è®¤åˆ†æ”¯æ”¹ä¸º Playerbot
        default: "Playerbot"
        type: string
      build_type:
        description: "ç¼–è¯‘ç±»å‹"
        required: true
        default: "MinSizeRel"
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
          - MinSizeRel
      modules:
        description: "æ¨¡å—åˆ—è¡¨ï¼ˆæ ¼å¼ï¼šä»“åº“åœ°å€ åˆ†æ”¯ï¼Œæ¯è¡Œä¸€ä¸ªï¼‰"
        required: false
        # ã€ä¿®æ”¹3ã€‘é»˜è®¤æ¨¡å—æ”¹ä¸º liyunfan1223/mod-playerbots.git master
        default: "https://github.com/liyunfan1223/mod-playerbots.git master"
        type: string
  push:
    branches: ["main"]
  schedule:
    # ä¸Šæµ·æ—¶é—´å‡Œæ™¨3ç‚¹ = UTCæ—¶é—´19ç‚¹ï¼ˆUTC+8ï¼‰
    - cron: "0 19 * * *"

jobs:
  build-and-annotate:
    runs-on: ubuntu-22.04
    steps:
      - name: æ£€æŸ¥ç³»ç»Ÿæ¶æ„ï¼ˆç¡®ä¿x86-64ï¼‰
        run: |
          if [ "$(uname -m)" != "x86_64" ]; then
            echo "âŒ ä»…æ”¯æŒx86_64æ¶æ„"
            exit 1
          fi
          echo "âœ… ç¡®è®¤æ¶æ„ï¼šx86_64"

      - name: å®‰è£…ä¾èµ–ï¼ˆå®˜æ–¹æ¨èï¼‰
        run: |
          sudo apt update -y
          sudo apt install -y git cmake make gcc g++ clang libmysqlclient-dev libssl-dev \
            libbz2-dev libreadline-dev libncurses-dev libboost-all-dev libcurl4-openssl-dev

      - name: å®šä¹‰æ—¶é—´æˆ³å˜é‡ï¼ˆUTCæ—¶é—´ï¼Œç”¨äºå‘½åï¼‰
        id: timestamp
        run: |
          echo "UTC_TIMESTAMP=$(date -u +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
          echo "SHANGHAI_TIMESTAMP=$(TZ='Asia/Shanghai' date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: å…‹éš†AzerothCoreä»“åº“
        run: |
          # ã€ä¿®æ”¹4ã€‘é»˜è®¤ä»“åº“/åˆ†æ”¯åŒæ­¥inputsçš„é»˜è®¤å€¼ï¼ˆé¿å…push/å®šæ—¶è§¦å‘æ—¶ç”¨æ—§é»˜è®¤å€¼ï¼‰
          REPO="${{ github.event.inputs.acore_repo || 'https://github.com/liyunfan1223/azerothcore-wotlk.git' }}"
          BRANCH="${{ github.event.inputs.acore_branch || 'Playerbot' }}"
          echo "ğŸ”§ å…‹éš†ä»“åº“ï¼š$REPOï¼ˆåˆ†æ”¯ï¼š$BRANCHï¼‰"
          git clone --depth 1 --branch "$BRANCH" "$REPO" azerothcore
          cd azerothcore
          git submodule update --init --recursive

      - name: æ‹‰å–æŒ‡å®šæ¨¡å—åˆ°modulesç›®å½•
        id: pull_modules
        run: |
          # å®šä¹‰æ¨¡å—ç›®å½•ï¼ˆAzerothCoreé»˜è®¤æ¨¡å—è·¯å¾„ï¼‰
          MODULES_DIR="azerothcore/modules"
          mkdir -p "$MODULES_DIR"
          
          # è¯»å–è¾“å…¥çš„æ¨¡å—åˆ—è¡¨ï¼ˆå¤šè¡Œï¼‰ï¼Œé»˜è®¤å€¼åŒæ­¥inputsçš„æ¨¡å—é…ç½®
          MODULES_INPUT="${{ github.event.inputs.modules || 'https://github.com/liyunfan1223/mod-playerbots.git master' }}"
          MODULES_LIST=()
          FAILURE_MODULES=()
          
          echo "ğŸ“¦ å¼€å§‹å¤„ç†æ¨¡å—åˆ—è¡¨..."
          # æŒ‰è¡Œåˆ†å‰²è¾“å…¥ï¼ˆå¿½ç•¥ç©ºè¡Œï¼‰
          while IFS= read -r line; do
            # è·³è¿‡ç©ºè¡Œ
            if [ -z "$line" ]; then
              continue
            fi
            # åˆ†å‰²ä»“åº“åœ°å€å’Œåˆ†æ”¯ï¼ˆé»˜è®¤åˆ†æ”¯masterï¼Œæ­¤å¤„è¾“å…¥å·²æŒ‡å®šmasterï¼Œå…¼å®¹é€»è¾‘ä¿ç•™ï¼‰
            REPO_URL=$(echo "$line" | awk '{print $1}')
            BRANCH=$(echo "$line" | awk '{print $2}' || echo "master")
            # ä»ä»“åº“URLæå–æ¨¡å—åï¼ˆå–æœ€åä¸€æ®µï¼Œå»æ‰.gitåç¼€ï¼‰
            MODULE_NAME=$(basename "$REPO_URL" .git)
            MODULE_PATH="$MODULES_DIR/$MODULE_NAME"
            
            echo "ğŸ”§ æ‹‰å–æ¨¡å—ï¼š$MODULE_NAMEï¼ˆä»“åº“ï¼š$REPO_URLï¼Œåˆ†æ”¯ï¼š$BRANCHï¼‰"
            # å…‹éš†æ¨¡å—åˆ°æŒ‡å®šç›®å½•
            if git clone --depth 1 --branch "$BRANCH" "$REPO_URL" "$MODULE_PATH"; then
              MODULES_LIST+=("$MODULE_NAMEï¼ˆ$BRANCHï¼‰")
            else
              echo "âš ï¸ æ¨¡å— $MODULE_NAME æ‹‰å–å¤±è´¥ï¼Œå°†è·³è¿‡è¯¥æ¨¡å—"
              FAILURE_MODULES+=("$MODULE_NAMEï¼ˆ$BRANCHï¼‰")
            fi
          done <<< "$MODULES_INPUT"
          
          # è¾“å‡ºæˆåŠŸ/å¤±è´¥çš„æ¨¡å—åˆ—è¡¨ï¼ˆç”¨äºåç»­Annotationsï¼‰
          echo "SUCCESS_MODULES=$(IFS=';'; echo "${MODULES_LIST[*]}")" >> $GITHUB_OUTPUT
          echo "FAILURE_MODULES=$(IFS=';'; echo "${FAILURE_MODULES[*]}")" >> $GITHUB_OUTPUT
          
          # æç¤ºç»“æœ
          if [ ${#MODULES_LIST[@]} -gt 0 ]; then
            echo "âœ… æˆåŠŸæ‹‰å–æ¨¡å—ï¼š${MODULES_LIST[*]}"
          fi
          if [ ${#FAILURE_MODULES[@]} -gt 0 ]; then
            echo "âš ï¸ æ‹‰å–å¤±è´¥çš„æ¨¡å—ï¼š${FAILURE_MODULES[*]}"
          fi

      - name: é…ç½®CMakeï¼ˆåŒ…å«æ¨¡å—ï¼‰
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'MinSizeRel' }}"
          mkdir -p azerothcore/build && cd azerothcore/build
          cmake ../ -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DCMAKE_C_COMPILER=/usr/bin/clang \
            -DCMAKE_CXX_COMPILER=/usr/bin/clang++ \
            -DBUILD_SHARED_LIBS=OFF \
            -DWITH_WARNINGS=1 \
            -DTOOLS_BUILD=all \
            -DSCRIPTS=static \
            -DMODULES=static  # é™æ€ç¼–è¯‘æ¨¡å—ï¼ˆç¡®ä¿æ‹‰å–çš„mod-playerbotsè¢«åŒ…å«ï¼‰

      - name: ç¼–è¯‘é¡¹ç›®ï¼ˆå«æ¨¡å—ï¼‰
        run: |
          cd azerothcore/build
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆä½¿ç”¨$(nproc)æ ¸å¿ƒï¼‰"
          make -j$(nproc)
          make install

      - name: æ‰“åŒ…ç¼–è¯‘ç»“æœï¼ˆUTCæ—¶é—´æˆ³å‘½åï¼‰
        id: package
        run: |
          TIMESTAMP="${{ steps.timestamp.outputs.UTC_TIMESTAMP }}"
          tar -czvf acore-build-${TIMESTAMP}.tar.gz -C azerothcore/install .
          PACKAGE_SIZE=$(du -h acore-build-${TIMESTAMP}.tar.gz | awk '{print $1}')
          echo "PACKAGE_NAME=acore-build-${TIMESTAMP}.tar.gz" >> $GITHUB_OUTPUT
          echo "PACKAGE_SIZE=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆï¼šacore-build-${TIMESTAMP}.tar.gzï¼ˆå¤§å°ï¼š$PACKAGE_SIZEï¼‰"

      - name: è¾“å‡ºç¼–è¯‘ç»“æœåˆ°Annotationsï¼ˆå«æ¨¡å—ä¿¡æ¯ï¼‰
        run: |
          UTC_TIME=$(date -u +'%Y-%m-%d %H:%M:%S')
          SHANGHAI_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          
          # å¤„ç†æ¨¡å—åˆ—è¡¨ï¼ˆè½¬æ¢ä¸ºæ¢è¡Œå±•ç¤ºï¼‰
          SUCCESS_MODULES=$(echo "${{ steps.pull_modules.outputs.SUCCESS_MODULES }}" | tr ';' '\n')
          FAILURE_MODULES=$(echo "${{ steps.pull_modules.outputs.FAILURE_MODULES }}" | tr ';' '\n')
          
          # è¾“å‡ºåˆ°GitHub Annotations
          echo "::notice title=ç¼–è¯‘äº§ç‰©ä¿¡æ¯::" >&2
          echo "::notice::ğŸ“¦ äº§ç‰©åç§°ï¼š${{ steps.package.outputs.PACKAGE_NAME }}" >&2
          echo "::notice::ğŸ“Š äº§ç‰©å¤§å°ï¼š${{ steps.package.outputs.PACKAGE_SIZE }}" >&2
          echo "::notice::ğŸ”— ç¼–è¯‘æ¥æºï¼š${{ github.event.inputs.acore_repo || 'https://github.com/liyunfan1223/azerothcore-wotlk.git' }}ï¼ˆåˆ†æ”¯ï¼š${{ github.event.inputs.acore_branch || 'Playerbot' }}ï¼‰" >&2
          echo "::notice::ğŸ”¨ ç¼–è¯‘ç±»å‹ï¼š${{ github.event.inputs.build_type || 'MinSizeRel' }}" >&2
          echo "::notice::â° UTCæ—¶é—´ï¼š$UTC_TIME" >&2
          echo "::notice::â° ä¸Šæµ·æ—¶é—´ï¼š$SHANGHAI_TIME" >&2
          
          # è¾“å‡ºæ¨¡å—ä¿¡æ¯
          if [ -n "$SUCCESS_MODULES" ]; then
            echo "::notice::ğŸ“Œ æˆåŠŸé›†æˆæ¨¡å—ï¼š" >&2
            echo "$SUCCESS_MODULES" | while read -r mod; do
              echo "::notice::  - $mod" >&2
            done
          else
            echo "::notice::ğŸ“Œ æœªé›†æˆä»»ä½•æ¨¡å—" >&2
          fi
          
          # è¾“å‡ºå¤±è´¥çš„æ¨¡å—ï¼ˆè­¦å‘Šçº§åˆ«ï¼‰
          if [ -n "$FAILURE_MODULES" ]; then
            echo "::warning::âš ï¸ æ‹‰å–å¤±è´¥çš„æ¨¡å—ï¼š" >&2
            echo "$FAILURE_MODULES" | while read -r mod; do
              echo "::warning::  - $mod" >&2
            done
          fi

      - name: ä¿å­˜äº§ç‰©ä¸ºArtifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.PACKAGE_NAME }}
          path: ${{ steps.package.outputs.PACKAGE_NAME }}
          retention-days: 7
