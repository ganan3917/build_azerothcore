name: 编译 AzerothCore-WoTLK (Windows x64)

on:
  workflow_dispatch:
    inputs:
      coreRepo:
        description: 'AzerothCore核心仓库URL'
        required: true
        default: 'https://github.com/azerothcore/azerothcore-wotlk.git'
      coreBranch:
        description: '核心仓库分支'
        required: true
        default: 'master'
      modules:
        description: '要安装的模块 (格式: 仓库URL:分支，多个用逗号分隔)'
        required: false
        default: 'https://github.com/azerothcore/mod-ah-bot:master,https://github.com/azerothcore/mod-ip-tracker:master'
      buildType:
        description: '编译类型'
        type: choice
        required: true
        default: 'RelWithDebInfo'
        options:
          - Release
          - RelWithDebInfo
          - Debug
      withTests:
        description: '是否编译测试'
        type: boolean
        required: true
        default: false

jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 120
    name: Windows x64 编译流程

    steps:
      - name: 系统信息
        run: |
          Write-Host "操作系统版本: $([Environment]::OSVersion.VersionString)"
          Write-Host "处理器数量: $($env:NUMBER_OF_PROCESSORS)"
        shell: pwsh

      - name: 安装 Chocolatey 包管理器
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        shell: pwsh

      - name: 配置Chocolatey源并安装基础依赖
        run: |
          # 添加并优先使用官方源
          choco sources add -n=chocolatey -s=https://community.chocolatey.org/api/v2/ --priority=1
          choco source enable -n=chocolatey
          
          # 安装基础依赖
          choco install -y cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          choco install -y git
          choco install -y openssl --version 1.1.1q
          choco install -y boost-msvc-14.3 --version 1.81.0.0
        shell: pwsh

      - name: 安装MySQL 8.4.6（带重试机制）
        run: |
          $mysqlVersion = "8.4.6"
          $retries = 3
          $success = $false
          
          for ($i = 1; $i -le $retries; $i++) {
              try {
                  Write-Host "第 $i 次尝试安装MySQL $mysqlVersion..."
                  # 使用--no-progress避免进度输出干扰，--yes自动确认
                  choco install -y mysql --version $mysqlVersion --no-progress --yes
                  
                  # 验证安装
                  if (Get-Command "mysql" -ErrorAction SilentlyContinue) {
                      $installedVersion = mysql --version | Select-String -Pattern "Ver (\d+\.\d+\.\d+)" | ForEach-Object { $_.Matches.Groups[1].Value }
                      if ($installedVersion -eq $mysqlVersion) {
                          Write-Host "MySQL $mysqlVersion 安装成功"
                          $success = $true
                          break
                      } else {
                          Write-Warning "安装的MySQL版本不匹配: 预期 $mysqlVersion, 实际 $installedVersion"
                      }
                  } else {
                      Write-Warning "MySQL未被正确安装到系统路径"
                  }
              } catch {
                  Write-Warning "第 $i 次安装失败: $_"
              }
              
              # 若未成功且不是最后一次尝试，则卸载后重试
              if (-not $success -and $i -lt $retries) {
                  Write-Host "卸载MySQL准备重试..."
                  choco uninstall -y mysql --no-progress --yes
                  Start-Sleep -Seconds 5
              }
          }
          
          if (-not $success) {
              Write-Error "经过 $retries 次尝试，MySQL $mysqlVersion 安装失败"
              exit 1
          }
        shell: pwsh

      - name: 配置MySQL环境变量
        run: |
          # 确保MySQL的bin目录在PATH中
          $mysqlPath = "C:\Program Files\MySQL\MySQL Server 8.4\bin"
          if (-not $env:PATH.Contains($mysqlPath)) {
              Write-Host "添加MySQL路径到环境变量: $mysqlPath"
              $env:PATH += ";$mysqlPath"
              # 持久化到系统环境变量
              [Environment]::SetEnvironmentVariable("PATH", $env:PATH, "Machine")
          }
          
          # 验证MySQL命令
          mysql --version
        shell: pwsh

      - name: 手动安装nlohmann-json头文件
        run: |
          $jsonVersion = "3.11.3"
          $zipUrl = "https://github.com/nlohmann/json/releases/download/v$jsonVersion/json.hpp"
          $installDir = "C:\ProgramFiles\nlohmann-json\include\nlohmann"
          
          New-Item -Path $installDir -ItemType Directory -Force | Out-Null
          Invoke-WebRequest -Uri $zipUrl -OutFile "$installDir\json.hpp"
          
          [Environment]::SetEnvironmentVariable("INCLUDE", "$env:INCLUDE;$installDir\..", "Machine")
          Write-Host "nlohmann-json v$jsonVersion 安装完成"
        shell: pwsh

      - name: 验证所有依赖
        run: |
          Write-Host "CMake版本: $(cmake --version | Select-Object -First 1)"
          Write-Host "Git版本: $(git --version)"
          Write-Host "OpenSSL版本: $(openssl version)"
          Write-Host "MySQL版本: $(mysql --version)"
          if (Test-Path "C:\ProgramFiles\nlohmann-json\include\nlohmann\json.hpp") {
              Write-Host "nlohmann-json 验证成功"
          } else {
              Write-Error "nlohmann-json 未找到"
              exit 1
          }
        shell: pwsh

      # 以下步骤与之前保持一致
      - name: 检出 AzerothCore 核心
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.coreRepo }}
          ref: ${{ github.event.inputs.coreBranch }}
          path: 'azerothcore'
          submodules: 'recursive'
          fetch-depth: 0

      - name: 安装指定模块
        if: ${{ github.event.inputs.modules != '' }}
        run: |
          $modulesList = "${{ github.event.inputs.modules }}".Split(',')
          $moduleDir = "azerothcore/modules"
          
          if (-not (Test-Path $moduleDir)) {
              New-Item -Path $moduleDir -ItemType Directory -Force | Out-Null
          }
          
          foreach ($module in $modulesList) {
              $module = $module.Trim()
              if ([string]::IsNullOrEmpty($module)) { continue }
              
              $parts = $module.Split(':')
              $repoUrl = $parts[0].Trim()
              $branch = if ($parts.Count -gt 1) { $parts[1].Trim() } else { 'master' }
              
              $moduleName = ($repoUrl -split '/' | Select-Object -Last 1) -replace '\.git$', ''
              $targetPath = "$moduleDir/$moduleName"
              
              Write-Host "安装模块: $moduleName 从 $repoUrl 分支 $branch"
              git clone --branch $branch --depth 1 $repoUrl $targetPath
              
              if (-not (Test-Path $targetPath)) {
                  Write-Error "模块 $moduleName 安装失败"
                  exit 1
              }
          }
        shell: pwsh

      - name: 配置 CMake
        run: |
          $buildType = "${{ github.event.inputs.buildType }}"
          $withTests = ${{ github.event.inputs.withTests }}
          
          New-Item -Path "azerothcore/build" -ItemType Directory -Force | Out-Null
          cd azerothcore/build
          
          $cmakeArgs = @(
              "..",
              "-G", "Visual Studio 17 2022",
              "-A", "x64",
              "-DCMAKE_INSTALL_PREFIX=../env/dist",
              "-DCMAKE_BUILD_TYPE=$buildType",
              "-DBUILD_AZEROTHCORE_TOOLS=ON",
              "-DSCRIPTS=static",
              "-DTOOLS=ON",
              "-DENABLE_MYSQL_CLIENT=ON",
              "-DUSE_SFMT=ON",
              "-DCMAKE_INCLUDE_PATH=C:\ProgramFiles\nlohmann-json\include"
          )
          
          if ($withTests) {
              $cmakeArgs += "-DBUILD_TESTING=ON"
          } else {
              $cmakeArgs += "-DBUILD_TESTING=OFF"
          }
          
          cmake $cmakeArgs
        shell: pwsh

      - name: 编译项目
        run: |
          cd azerothcore/build
          msbuild AzerothCore.sln /p:Configuration=${{ github.event.inputs.buildType }} /p:Platform=x64 /maxcpucount /verbosity:minimal
        shell: pwsh

      - name: 安装编译结果
        run: |
          cd azerothcore/build
          msbuild INSTALL.vcxproj /p:Configuration=${{ github.event.inputs.buildType }} /p:Platform=x64 /maxcpucount
        shell: pwsh

      - name: 验证编译结果
        run: |
          $exePath = "azerothcore/env/dist/bin/worldserver.exe"
          if (Test-Path $exePath) {
              Write-Host "编译成功! 找到 worldserver.exe"
              Get-Item $exePath | Select-Object Name, Length, LastWriteTime
          } else {
              Write-Error "编译失败! 未找到 worldserver.exe"
              exit 1
          }
        shell: pwsh

      - name: 打包编译产物
        run: |
          $zipName = "azerothcore-${{ github.sha }}-${{ github.event.inputs.buildType }}.zip"
          Compress-Archive -Path azerothcore/env/dist/* -DestinationPath $zipName -Force
          Write-Host "产物已打包为: $zipName"
        shell: pwsh

      - name: 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: azerothcore-windows-x64-${{ github.event.inputs.buildType }}
          path: azerothcore-*.zip
          retention-days: 7
          if-no-files-found: error
