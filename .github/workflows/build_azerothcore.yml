name: build_azerothcore

on:
  workflow_dispatch:
    inputs:
      acore_repo:
        description: "AzerothCoreä»“åº“åœ°å€"
        required: true
        default: "https://github.com/liyunfan1223/azerothcore-wotlk.git"
        type: string
      acore_branch:
        description: "AzerothCoreåˆ†æ”¯"
        required: true
        default: "Playerbot"
        type: string
      build_type:
        description: "ç¼–è¯‘ç±»å‹"
        required: true
        default: "MinSizeRel"
        type: choice
        options: [Debug, Release, RelWithDebInfo, MinSizeRel]
      modules:
        description: "æ¨¡å—åˆ—è¡¨ï¼ˆæ ¼å¼ï¼šä»“åº“åœ°å€ åˆ†æ”¯ï¼Œæ¯è¡Œä¸€ä¸ªï¼‰"
        required: false
        default: |
          https://github.com/liyunfan1223/mod-playerbots.git master
          https://github.com/azerothcore/mod-eluna.git master
          https://github.com/azerothcore/mod-learn-spells.git master
          https://github.com/azerothcore/mod-autobalance.git master
          https://github.com/azerothcore/mod-auto-revive.git master
        type: string
  push: { branches: ["main"] }
  schedule: [{ cron: "0 19 * * *" }]  # ä¸Šæµ·æ—¶é—´å‡Œæ™¨3ç‚¹ï¼ˆUTC+8ï¼‰

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      # ç»Ÿä¸€é»˜è®¤å‚æ•°ï¼Œé¿å…é‡å¤å®šä¹‰
      ACORE_REPO: ${{ github.event.inputs.acore_repo || 'https://github.com/liyunfan1223/azerothcore-wotlk.git' }}
      ACORE_BRANCH: ${{ github.event.inputs.acore_branch || 'Playerbot' }}
      BUILD_TYPE: ${{ github.event.inputs.build_type || 'MinSizeRel' }}
      MODULES_INPUT: ${{ github.event.inputs.modules || 'https://github.com/liyunfan1223/mod-playerbots.git master' }}
      MODULES_DIR: azerothcore/modules

    steps:
      - name: æ£€æŸ¥æ¶æ„ï¼ˆä»…x86_64ï¼‰
        run: |
          [ "$(uname -m)" = "x86_64" ] || { echo "âŒ ä»…æ”¯æŒx86_64æ¶æ„"; exit 1; }
          echo "âœ… ç¡®è®¤æ¶æ„ï¼šx86_64"

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y git cmake make gcc g++ clang libmysqlclient-dev libssl-dev \
            libbz2-dev libreadline-dev libncurses-dev libboost-all-dev libcurl4-openssl-dev

      - name: ç”Ÿæˆæ—¶é—´æˆ³
        id: ts
        run: |
          echo "utc=$(date -u +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT
          echo "sh=$(TZ='Asia/Shanghai' date +%Y%m%d%H%M%S)" >> $GITHUB_OUTPUT

      - name: å…‹éš†æ ¸å¿ƒä»“åº“
        run: |
          echo "ğŸ”§ å…‹éš†ä»“åº“ï¼š$ACORE_REPOï¼ˆåˆ†æ”¯ï¼š$ACORE_BRANCHï¼‰"
          git clone --depth 1 --branch "$ACORE_BRANCH" "$ACORE_REPO" azerothcore
          cd azerothcore && git submodule update --init --recursive

      - name: æ‹‰å–æ¨¡å—
        id: modules
        run: |
          mkdir -p "$MODULES_DIR"
          success=()
          failure=()
          
          echo "ğŸ“¦ å¤„ç†æ¨¡å—åˆ—è¡¨..."
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | awk '{print $1}')
            branch=$(echo "$line" | awk '{print $2}')
            name=$(basename "$repo" .git)
            path="$MODULES_DIR/$name"
            
            if git clone --depth 1 --branch "$branch" "$repo" "$path"; then
              success+=("$nameï¼ˆ$branchï¼‰")
            else
              failure+=("$nameï¼ˆ$branchï¼‰")
              echo "âš ï¸ æ¨¡å— $name æ‹‰å–å¤±è´¥"
            fi
          done <<< "$MODULES_INPUT"
          
          echo "success=$(IFS=';'; echo "${success[*]}")" >> $GITHUB_OUTPUT
          echo "failure=$(IFS=';'; echo "${failure[*]}")" >> $GITHUB_OUTPUT

      - name: é…ç½®CMake
        run: |
          mkdir -p azerothcore/build && cd azerothcore/build
          cmake ../ -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ \
            -DBUILD_SHARED_LIBS=OFF -DWITH_WARNINGS=1 \
            -DTOOLS_BUILD=all -DSCRIPTS=static -DMODULES=static

      - name: ç¼–è¯‘å®‰è£…
        run: |
          cd azerothcore/build
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆ$(nproc)æ ¸å¿ƒï¼‰"
          make -j$(nproc) && make install

      - name: æ‰“åŒ…äº§ç‰©
        id: package
        run: |
            tar -czvf acore-${{ steps.ts.outputs.utc }}.tar.gz -C azerothcore/install .
            echo "name=acore-${{ steps.ts.outputs.utc }}.tar.gz" >> $GITHUB_OUTPUT
            # ä¿®æ­£ï¼šç”¨ du -b è¾“å‡ºå­—èŠ‚æ•°ï¼ˆæ— å•ä½ï¼‰ï¼Œä»…ä¿ç•™çº¯æ•°å­—
            echo "size=$(du -b ${{ steps.package.outputs.name }} | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: è¾“å‡ºåˆ°Annotations
        run: |
          # å•ç‹¬è·å–å¸¦å•ä½çš„å¤§å°ç”¨äºæ˜¾ç¤º
          human_size=$(du -h ${{ steps.package.outputs.name }} | awk '{print $1}')
          echo "::notice::ğŸ“¦ äº§ç‰©: ${{ steps.package.outputs.name }} (${human_size})" >&2
          
          # æ ¼å¼åŒ–æ¨¡å—åˆ—è¡¨
          success=$(echo "${{ steps.modules.outputs.success }}" | tr ';' '\n')
          failure=$(echo "${{ steps.modules.outputs.failure }}" | tr ';' '\n')
          
          # æ ¸å¿ƒä¿¡æ¯
          echo "::notice title=ç¼–è¯‘ä¿¡æ¯::" >&2
          echo "::notice::ğŸ“¦ äº§ç‰©: ${{ steps.package.outputs.name }} (${{ steps.package.outputs.size }})" >&2
          echo "::notice::ğŸ”— æ¥æº: $ACORE_REPO ($ACORE_BRANCH)" >&2
          echo "::notice::ğŸ”¨ ç±»å‹: $BUILD_TYPE" >&2
          echo "::notice::â° æ—¶é—´: UTC $utc / ä¸Šæµ· $sh" >&2
          
          # æ¨¡å—ä¿¡æ¯
          [ -n "$success" ] && { echo "::notice::ğŸ“Œ æˆåŠŸæ¨¡å—:" >&2; echo "$success" | xargs -I{} echo "::notice::  - {}" >&2; }
          [ -z "$success" ] && echo "::notice::ğŸ“Œ æ— æ¨¡å—é›†æˆ" >&2
          [ -n "$failure" ] && { echo "::warning::âš ï¸ å¤±è´¥æ¨¡å—:" >&2; echo "$failure" | xargs -I{} echo "::warning::  - {}" >&2; }

      - name: ä¿å­˜äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.name }}
          path: ${{ steps.package.outputs.name }}
          retention-days: 7
