name: build_azerothcore

on:
  workflow_dispatch:
  schedule:
    - cron: 0 19 * * *

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write  # å‘å¸ƒReleasesæƒé™
    env:
      ACORE_REPO: "https://github.com/liyunfan1223/azerothcore-wotlk.git"
      ACORE_BRANCH: "Playerbot"
      BUILD_TYPE: "MinSizeRel"
      MODULES_INPUT: |
        https://github.com/liyunfan1223/mod-playerbots.git master
        https://github.com/azerothcore/mod-eluna.git master
        https://github.com/azerothcore/mod-learn-spells.git master
        https://github.com/azerothcore/mod-autobalance.git master
        https://github.com/azerothcore/mod-auto-revive.git master
      MODULES_DIR: azerothcore/modules
      RETAIN_COUNT: 3  # ä¿ç•™æœ€æ–°3ä¸ªRelease

    steps:
      - name: æ£€æŸ¥æ¶æ„ï¼ˆä»…x86_64ï¼‰
        run: |
          [ "$(uname -m)" = "x86_64" ] || { echo "âŒ ä»…æ”¯æŒx86_64æ¶æ„"; exit 1; }
          echo "âœ… æ¶æ„ç¡®è®¤: x86_64"

      - name: å®‰è£…ä¾èµ–ï¼ˆå«æœ€æ–°ghå’Œjqï¼‰
        run: |
          sudo apt update -y
          # å¸è½½æ—§ç‰ˆghï¼ˆè‹¥å­˜åœ¨ï¼‰
          sudo apt remove -y gh || true
          # å®‰è£…ghå®˜æ–¹æºï¼ˆæœ€æ–°ç‰ˆï¼‰
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆå«jqï¼‰
          sudo apt update -y
          sudo apt install -y git cmake make gcc g++ clang libmysqlclient-dev libssl-dev \
            libbz2-dev libreadline-dev libncurses-dev libboost-all-dev libcurl4-openssl-dev \
            gh jq

      - name: ç”Ÿæˆæ—¶é—´æˆ³ä¸Releaseæ ‡ç­¾
        id: ts
        run: |
          UTC_TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          SH_TIMESTAMP=$(TZ='Asia/Shanghai' date +%Y%m%d%H%M%S)
          RELEASE_TAG="build-$UTC_TIMESTAMP"
          echo "utc=$UTC_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "sh=$SH_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "ç”Ÿæˆçš„æ ‡ç­¾: $RELEASE_TAG"  # è°ƒè¯•è¾“å‡º

      - name: å…‹éš†æ ¸å¿ƒä»“åº“ä¸å­æ¨¡å—
        run: |
          git clone --depth 1 --branch "$ACORE_BRANCH" "$ACORE_REPO" azerothcore
          cd azerothcore && git submodule update --init --recursive

      - name: æ‹‰å–æ¨¡å—ï¼ˆè®°å½•æˆåŠŸ/å¤±è´¥çŠ¶æ€ï¼‰
        id: modules
        run: |
          mkdir -p "$MODULES_DIR"
          success=()
          failure=()
          
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | awk '{print $1}')
            branch=$(echo "$line" | awk '{print $2}')
            mod_name=$(basename "$repo" .git)
            
            if git clone --depth 1 --branch "$branch" "$repo" "$MODULES_DIR/$mod_name"; then
              success+=("$mod_name")
            else
              failure+=("$mod_name")
              echo "âš ï¸ æ¨¡å— $mod_name æ‹‰å–å¤±è´¥"
            fi
          done <<< "$MODULES_INPUT"
          
          echo "success=$(IFS=,; echo "${success[*]}")" >> $GITHUB_OUTPUT
          echo "failure=$(IFS=,; echo "${failure[*]}")" >> $GITHUB_OUTPUT

      - name: é…ç½®CMake + ç¼–è¯‘å®‰è£…
        run: |
          mkdir -p azerothcore/build && cd azerothcore/build
          cmake ../ \
            -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ \
            -DBUILD_SHARED_LIBS=OFF -DWITH_WARNINGS=1 \
            -DTOOLS_BUILD=all -DSCRIPTS=static -DMODULES=static
          make -j$(nproc) && make install

      - name: æ‰“åŒ…ç¼–è¯‘äº§ç‰©
        id: package
        run: |
          PACKAGE_NAME="acore-${{ steps.ts.outputs.utc }}.tar.gz"
          tar -czvf "$PACKAGE_NAME" -C azerothcore/install .
          echo "name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          # éªŒè¯åŒ…æ˜¯å¦ç”Ÿæˆ
          if [ -f "$PACKAGE_NAME" ]; then
            echo "âœ… äº§ç‰©åŒ…ç”ŸæˆæˆåŠŸ: $PACKAGE_NAME"
          else
            echo "âŒ äº§ç‰©åŒ…ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

      - name: ä¿å­˜äº§ç‰©åˆ°Artifactï¼ˆå¤‡ä»½ç”¨ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.name }}
          path: ${{ steps.package.outputs.name }}
          retention-days: 7

      - name: å‘å¸ƒåˆ°Releases + æ¸…ç†æ—§ç‰ˆæœ¬
        run: |
          set -x  # è¾“å‡ºæ‰€æœ‰æ‰§è¡Œå‘½ä»¤ï¼Œä¾¿äºè°ƒè¯•
          
          # 1. éªŒè¯GitHub CLIç™»å½•
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status || { echo "âŒ GitHub CLIç™»å½•å¤±è´¥"; exit 1; }
          
          # 2. åˆ›å»ºReleaseï¼ˆå¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
          NOTES=$(printf "æ ¸å¿ƒåˆ†æ”¯: %s | æˆåŠŸæ¨¡å—: %s | å¤±è´¥æ¨¡å—: %s" \
            "$ACORE_BRANCH" \
            "${{ steps.modules.outputs.success }}" \
            "${{ steps.modules.outputs.failure }}"
          )
          gh release create ${{ steps.ts.outputs.tag }} \
            --title "Build ${{ steps.ts.outputs.sh }}ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰" \
            --notes "$NOTES" \
            --prerelease || { echo "âŒ åˆ›å»ºReleaseå¤±è´¥"; exit 1; }
          
          # 3. ä¸Šä¼ äº§ç‰©åˆ°Release
          PACKAGE_NAME="${{ steps.package.outputs.name }}"
          if [ ! -f "$PACKAGE_NAME" ]; then
            echo "âŒ äº§ç‰©æ–‡ä»¶ä¸å­˜åœ¨: $PACKAGE_NAME"
            exit 1
          fi
          gh release upload ${{ steps.ts.outputs.tag }} "$PACKAGE_NAME" --clobber || { echo "âŒ ä¸Šä¼ äº§ç‰©å¤±è´¥"; exit 1; }
          
          # 4. æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™æœ€æ–°${RETAIN_COUNT}ä¸ªï¼Œå®¹é”™å¤„ç†ï¼‰
          gh release list --limit 100 --json tagName \
            | jq -r '.[] | select(.tagName | startswith("build-")) | .tagName' \
            | sort -r \
            | tail -n +$((RETAIN_COUNT + 1)) \
            | while read -r old_tag; do
                if [ -n "$old_tag" ]; then
                  echo "ğŸ—‘ï¸ å°è¯•åˆ é™¤æ—§Release: $old_tag"
                  # å…è®¸å•ä¸ªåˆ é™¤å¤±è´¥ï¼Œé¿å…ä¸­æ–­æ•´ä¸ªæµç¨‹
                  gh release delete "$old_tag" --yes || echo "âš ï¸ å¿½ç•¥åˆ é™¤Release $old_tag å¤±è´¥"
                  git push origin --delete "$old_tag" || echo "âš ï¸ å¿½ç•¥åˆ é™¤æ ‡ç­¾ $old_tag å¤±è´¥"
                fi
              done
