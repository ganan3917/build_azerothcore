name: build_azerothcore

on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      ACORE_REPO: "https://github.com/liyunfan1223/azerothcore-wotlk.git"
      ACORE_BRANCH: "Playerbot"
      BUILD_TYPE: "MinSizeRel"
      MODULES_INPUT: |
        https://github.com/liyunfan1223/mod-playerbots.git master
        https://github.com/azerothcore/mod-eluna.git master
        https://github.com/azerothcore/mod-learn-spells.git master
        https://github.com/azerothcore/mod-autobalance.git master
        https://github.com/azerothcore/mod-auto-revive.git master
      MODULES_DIR: azerothcore/modules
      RETAIN_COUNT: 3  # ä¿ç•™æœ€æ–°3ä¸ªRelease
      ARTIFACT_NAME: "azerothcore-build"
      RELEASE_TAG: "build-$(date +%Y%m%d-%H%M%S)"  # åŸºäºç‰ˆæœ¬æ ‡ç­¾ï¼ˆæ—¶é—´æˆ³ï¼‰

    steps:
      - name: æ£€æŸ¥æ¶æ„ï¼ˆä»…x86_64ï¼‰
        run: |
          if [ "$(uname -m)" != "x86_64" ]; then
            echo "âŒ ä»…æ”¯æŒx86_64æ¶æ„"
            exit 1
          fi
          echo "âœ… æ¶æ„ç¡®è®¤: x86_64"

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update -yq
          sudo apt install -yq \
            git cmake make clang \
            libmysqlclient-dev libssl-dev libbz2-dev \
            libreadline-dev libncurses-dev libboost-all-dev \
            libcurl4-openssl-dev
          sudo apt clean

      - name: å…‹éš†æ ¸å¿ƒä»“åº“ä¸å­æ¨¡å—
        run: |
          git clone --depth 1 --branch "$ACORE_BRANCH" "$ACORE_REPO" azerothcore
          cd azerothcore && git submodule update --init --recursive --depth 1

      - name: æ‹‰å–æ¨¡å—
        id: modules
        run: |
          mkdir -p "$MODULES_DIR"
          success=()
          failure=()
          
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            repo=$(echo "$line" | awk '{print $1}')
            branch=$(echo "$line" | awk '{print $2}')
            mod_name=$(basename "$repo" .git)
            
            if git clone --depth 1 --branch "$branch" "$repo" "$MODULES_DIR/$mod_name"; then
              success+=("$mod_name")
            else
              failure+=("$mod_name")
              echo "âš ï¸ æ¨¡å— $mod_name æ‹‰å–å¤±è´¥"
            fi
          done <<< "$MODULES_INPUT"
          
          echo "success=${success[*]}" | tr ' ' ',' >> $GITHUB_OUTPUT
          echo "failure=${failure[*]}" | tr ' ' ',' >> $GITHUB_OUTPUT

      - name: é…ç½®ä¸ç¼–è¯‘
        run: |
          mkdir -p azerothcore/build && cd azerothcore/build
          cmake ../ \
            -DCMAKE_BUILD_TYPE="$BUILD_TYPE" \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DBUILD_SHARED_LIBS=OFF \
            -DWITH_WARNINGS=1 \
            -DTOOLS_BUILD=all \
            -DSCRIPTS=static \
            -DMODULES=static
          make -j$(nproc)
          make install

      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          # è¿›å…¥å®‰è£…ç›®å½•æ‰“åŒ…ï¼ˆåŒ…å«binã€etcã€libç­‰æ ¸å¿ƒæ–‡ä»¶ï¼‰
          cd azerothcore/install
          zip -r "${{ env.ARTIFACT_NAME }}.zip" ./*
          # ç§»åŠ¨åˆ°æ ¹ç›®å½•ä¾¿äºä¸Šä¼ 
          mv "${{ env.ARTIFACT_NAME }}.zip" ../../

      - name: åˆ›å»ºGitHub Releaseå¹¶ä¸Šä¼ äº§ç‰©
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "è‡ªåŠ¨æ„å»º ${{ env.RELEASE_TAG }}"
          body: |
            ## æ„å»ºä¿¡æ¯
            - æ ¸å¿ƒåˆ†æ”¯: ${{ env.ACORE_BRANCH }}
            - æˆåŠŸé›†æˆæ¨¡å—: ${{ steps.modules.outputs.success }}
            - å¤±è´¥æ¨¡å—: ${{ steps.modules.outputs.failure || 'æ— ' }}
            - æ„å»ºæ—¶é—´: ${{ github.run_at }}
          files: ${{ env.ARTIFACT_NAME }}.zip
          draft: false
          prerelease: false

      - name: æ¸…ç†æ—§ç‰ˆæœ¬Release
        run: |
          # å®‰è£…GitHub CLIå·¥å…·ï¼ˆç”¨äºæ“ä½œReleaseï¼‰
          type gh >/dev/null 2>&1 || {
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update -yq && sudo apt install -yq gh
          }
          
          # é…ç½®GitHubè®¤è¯ï¼ˆä½¿ç”¨å·¥ä½œæµå†…ç½®ä»¤ç‰Œï¼‰
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          
          # è·å–æ‰€æœ‰Releaseæ ‡ç­¾ï¼ˆæŒ‰åˆ›å»ºæ—¶é—´å€’åºï¼‰ï¼Œè·³è¿‡å‰Nä¸ªä¿ç•™ç‰ˆæœ¬ï¼Œåˆ é™¤å…¶ä½™
          gh release list --limit 100 --json tagName --jq '.[].tagName' | tail -n +$((RETAIN_COUNT + 1)) | while read -r tag; do
            echo "ğŸ—‘ï¸ åˆ é™¤æ—§ç‰ˆæœ¬: $tag"
            gh release delete "$tag" --yes
            # åŒæ—¶åˆ é™¤å¯¹åº”çš„Gitæ ‡ç­¾
            git push origin --delete "$tag"
          done
