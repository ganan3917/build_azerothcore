name: ç¼–è¯‘AzerothCoreï¼ˆWindows x86-64ï¼‰å¹¶è¾“å‡ºåˆ°Annotations

on:
  workflow_dispatch:
    inputs:
      acore_repo:
        description: "AzerothCoreä»“åº“åœ°å€"
        required: true
        default: "https://github.com/azerothcore/azerothcore-wotlk.git"
        type: string
      acore_branch:
        description: "AzerothCoreåˆ†æ”¯"
        required: true
        default: "master"
        type: string
      build_type:
        description: "ç¼–è¯‘ç±»å‹"
        required: true
        default: "RelWithDebInfo"
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
          - MinSizeRel
  push:
    branches: ["main"]

jobs:
  build-windows-x64:
    runs-on: windows-2022  # ä½¿ç”¨Windows Server 2022ç¯å¢ƒï¼ˆæ”¯æŒx86-64ï¼‰
    steps:
      - name: æ£€æŸ¥ç³»ç»Ÿæ¶æ„ï¼ˆç¡®ä¿x86-64ï¼‰
        run: |
          $arch = (Get-CimInstance Win32_OperatingSystem).OSArchitecture
          if ($arch -ne "64-bit") {
            Write-Error "âŒ ä»…æ”¯æŒx86-64æ¶æ„ï¼ˆå½“å‰ï¼š$archï¼‰"
            exit 1
          }
          Write-Host "âœ… ç¡®è®¤æ¶æ„ï¼šx86-64"
        shell: pwsh

      - name: å®‰è£…ä¾èµ–ï¼ˆé€šè¿‡Chocolateyï¼‰
        run: |
          # å®‰è£…ChocolateyåŒ…ç®¡ç†å™¨ï¼ˆè‹¥æœªå®‰è£…ï¼‰
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          # å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆé€‚é…Windows x64ï¼‰
          choco install -y git cmake 7zip visualstudio2022-build-tools boost-msvc-14.3 mysql-connector-c++ openssl bzip2
          # é…ç½®ç¯å¢ƒå˜é‡ï¼ˆç¡®ä¿å·¥å…·å¯è¢«æ‰¾åˆ°ï¼‰
          echo "C:\Program Files\CMake\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\Program Files\7-Zip" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        shell: pwsh

      - name: å®šä¹‰æ—¶é—´æˆ³å˜é‡ï¼ˆç”¨äºå‘½åï¼‰
        id: timestamp
        run: |
          $timestamp = Get-Date -Format "yyyyMMddHHmmss"
          echo "TIMESTAMP=$timestamp" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh

      - name: å…‹éš†AzerothCoreä»“åº“
        run: |
          $repo = "${{ github.event.inputs.acore_repo || 'https://github.com/azerothcore/azerothcore-wotlk.git' }}"
          $branch = "${{ github.event.inputs.acore_branch || 'master' }}"
          Write-Host "ğŸ”§ å…‹éš†ä»“åº“ï¼š$repoï¼ˆåˆ†æ”¯ï¼š$branchï¼‰"
          git clone --depth 1 --branch $branch $repo azerothcore
          cd azerothcore
          git submodule update --init --recursive
        shell: pwsh

      - name: é…ç½®CMakeï¼ˆç”ŸæˆVSè§£å†³æ–¹æ¡ˆï¼Œç›®æ ‡x64ï¼‰
        run: |
          $buildType = "${{ github.event.inputs.build_type || 'RelWithDebInfo' }}"
          # åˆ›å»ºæ„å»ºç›®å½•
          New-Item -Path azerothcore\build -ItemType Directory -Force | Out-Null
          cd azerothcore\build
          # ç”ŸæˆVS2022è§£å†³æ–¹æ¡ˆï¼ˆx64æ¶æ„ï¼‰
          cmake .. `
            -G "Visual Studio 17 2022" `  # æŒ‡å®šVS2022ç”Ÿæˆå™¨
            -A x64 `                      # ç›®æ ‡æ¶æ„ï¼šx86-64
            -DCMAKE_BUILD_TYPE=$buildType `
            -DCMAKE_INSTALL_PREFIX=../install `
            -DBUILD_SHARED_LIBS=OFF `
            -DWITH_WARNINGS=1 `
            -DTOOLS_BUILD=all `
            -DSCRIPTS=static `
            -DMODULES=static `
            -DMySQL_INCLUDE_DIR="C:\Program Files\MySQL\MySQL Connector C++ 8.0\include" `  # MySQLå¤´æ–‡ä»¶è·¯å¾„
            -DMySQL_LIBRARY="C:\Program Files\MySQL\MySQL Connector C++ 8.0\lib64\mysqlcppconn8.lib"  # MySQLåº“è·¯å¾„
        shell: pwsh

      - name: ç¼–è¯‘é¡¹ç›®ï¼ˆä½¿ç”¨MSBuildï¼‰
        run: |
          $buildType = "${{ github.event.inputs.build_type || 'RelWithDebInfo' }}"
          cd azerothcore\build
          # ä½¿ç”¨MSBuildç¼–è¯‘ï¼ˆå¤šçº¿ç¨‹åŠ é€Ÿï¼‰
          cmake --build . --config $buildType --parallel (Get-CimInstance Win32_Processor).NumberOfLogicalProcessors
          # å®‰è£…ç¼–è¯‘äº§ç‰©åˆ°installç›®å½•
          cmake --build . --config $buildType --target install
        shell: pwsh

      - name: æ‰“åŒ…ç¼–è¯‘ç»“æœï¼ˆ7-Zipå‹ç¼©ï¼‰
        id: package
        run: |
          $timestamp = "${{ steps.timestamp.outputs.TIMESTAMP }}"
          $packageName = "acore-build-windows-x64-${timestamp}.zip"
          # å‹ç¼©installç›®å½•ï¼ˆåŒ…å«æ‰€æœ‰äº§ç‰©ï¼‰
          7z a -tzip $packageName .\azerothcore\install\*
          # è·å–åŒ…å¤§å°ï¼ˆç”¨äºAnnotationsï¼‰
          $packageSize = (Get-Item $packageName).Length / 1MB
          $packageSize = [math]::Round($packageSize, 2)
          echo "PACKAGE_NAME=$packageName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "PACKAGE_SIZE=${packageSize} MB" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "ğŸ“¦ æ‰“åŒ…å®Œæˆï¼š$packageNameï¼ˆå¤§å°ï¼š$packageSize MBï¼‰"
        shell: pwsh

      - name: è¾“å‡ºç¼–è¯‘ç»“æœåˆ°Annotations
        run: |
          # GitHub Annotationsæ ¼å¼ï¼ˆè¾“å‡ºåˆ°stderrï¼‰
          Write-Error "::notice title=ç¼–è¯‘äº§ç‰©ä¿¡æ¯::" -ErrorAction Continue
          Write-Error "::notice::ğŸ“¦ äº§ç‰©åç§°ï¼š${{ steps.package.outputs.PACKAGE_NAME }}" -ErrorAction Continue
          Write-Error "::notice::ğŸ“Š äº§ç‰©å¤§å°ï¼š${{ steps.package.outputs.PACKAGE_SIZE }}" -ErrorAction Continue
          Write-Error "::notice::ğŸ”— ç¼–è¯‘æ¥æºï¼š${{ github.event.inputs.acore_repo || 'https://github.com/azerothcore/azerothcore-wotlk.git' }}ï¼ˆåˆ†æ”¯ï¼š${{ github.event.inputs.acore_branch || 'master' }}ï¼‰" -ErrorAction Continue
          Write-Error "::notice::ğŸ”¨ ç¼–è¯‘ç±»å‹ï¼š${{ github.event.inputs.build_type || 'RelWithDebInfo' }}" -ErrorAction Continue
          Write-Error "::notice::ğŸ’» ç›®æ ‡æ¶æ„ï¼šWindows x86-64" -ErrorAction Continue
          Write-Error "::notice::â° ç¼–è¯‘æ—¶é—´ï¼š$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ErrorAction Continue
        shell: pwsh

      # å¯é€‰ï¼šä¿å­˜äº§ç‰©ä¸ºArtifactï¼ˆä¿ç•™7å¤©ï¼Œæ–¹ä¾¿ä¸‹è½½ï¼‰
      - name: ä¿å­˜äº§ç‰©ä¸ºArtifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.PACKAGE_NAME }}
          path: ${{ steps.package.outputs.PACKAGE_NAME }}
          retention-days: 7
