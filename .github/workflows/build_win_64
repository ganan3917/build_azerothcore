name: ç¼–è¯‘AzerothCoreï¼ˆWindows x64 VS2022ï¼‰

on:
  workflow_dispatch:
    inputs:
      acore_repo:
        description: "AzerothCoreä»“åº“åœ°å€"
        required: true
        default: "https://github.com/azerothcore/azerothcore-wotlk.git"
        type: string
      acore_branch:
        description: "AzerothCoreåˆ†æ”¯"
        required: true
        default: "master"
        type: string
      build_type:
        description: "ç¼–è¯‘ç±»å‹"
        required: true
        default: "RelWithDebInfo"
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
          - MinSizeRel
  push:
    branches: ["main"]

jobs:
  build-x64-vs2022:
    runs-on: windows-2022
    steps:
      # 1. æ£€æŸ¥ç³»ç»Ÿæ¶æ„ï¼ˆç¡®ä¿x64ï¼‰
      - name: éªŒè¯x86-64æ¶æ„
        run: |
          $arch = (Get-CimInstance Win32_OperatingSystem).OSArchitecture
          if ($arch -ne "64-bit") {
            Write-Error "âŒ ä»…æ”¯æŒx64æ¶æ„ï¼ˆå½“å‰ï¼š$archï¼‰"
            exit 1
          }
          Write-Host "âœ… ç¡®è®¤æ¶æ„ï¼šx64"
        shell: pwsh

      # 2. å®‰è£…å¿…è¦ä¾èµ–ï¼ˆåˆ©ç”¨runneré¢„è£…å·¥å…·ï¼Œä»…è¡¥å……ç¼ºå¤±ç»„ä»¶ï¼‰
      - name: å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          # å®‰è£…Chocolateyï¼ˆè‹¥æœªé¢„è£…ï¼‰
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force
            [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
            iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          # å®‰è£…AzerothCoreæ ¸å¿ƒä¾èµ–ï¼ˆæŒ‡å®šç¨³å®šç‰ˆæœ¬ï¼‰
          choco install -y `
            boost-msvc-14.3 --version 1.81.0 `  # åŒ¹é…VS2022ï¼ˆMSVC 14.3ï¼‰
            mysql-connector-c++ --version 8.0.33 `
            openssl --version 3.1.2 `
            bzip2 7zip
        shell: pwsh

      # 3. å…‹éš†ä»£ç åŠå­æ¨¡å—
      - name: å…‹éš†AzerothCoreä»“åº“
        run: |
          $repo = "${{ github.event.inputs.acore_repo }}"
          $branch = "${{ github.event.inputs.acore_branch }}"
          Write-Host "ğŸ”§ å…‹éš†ä»“åº“ï¼š$repoï¼ˆåˆ†æ”¯ï¼š$branchï¼‰"
          git clone --depth 1 --branch $branch $repo azerothcore
          cd azerothcore
          git submodule update --init --recursive --depth 1  # é€’å½’æ‹‰å–å­æ¨¡å—
        shell: pwsh

      # 4. CMakeç”ŸæˆVS2022 x64è§£å†³æ–¹æ¡ˆï¼ˆåŠ¨æ€ä¾èµ–è·¯å¾„ï¼‰
      - name: ç”ŸæˆVS2022 x64è§£å†³æ–¹æ¡ˆ
        id: cmake-config
        run: |
          New-Item -Path azerothcore/build -ItemType Directory -Force | Out-Null
          cd azerothcore/build

          # åŠ¨æ€è·å–ä¾èµ–å®‰è£…è·¯å¾„ï¼ˆé€‚é…ç‰ˆæœ¬æ›´æ–°ï¼‰
          $mysqlPath = (Get-Item "C:\Program Files\MySQL\MySQL Connector C++ *").FullName
          $boostPath = (Get-Item "C:\ProgramData\chocolatey\lib\boost-msvc-14.3\tools\boost_*").FullName
          $opensslPath = "C:\Program Files\OpenSSL"

          # CMakeé…ç½®ï¼ˆå¼ºåˆ¶x64æ¶æ„ï¼‰
          cmake .. `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -DCMAKE_INSTALL_PREFIX=../install `
            -DBUILD_SHARED_LIBS=OFF `
            -DWITH_WARNINGS=ON `
            -DTOOLS_BUILD=all `
            -DSCRIPTS=static `
            -DMODULES=static `
            -DMySQL_INCLUDE_DIR="$mysqlPath\include" `
            -DMySQL_LIBRARY="$mysqlPath\lib64\mysqlcppconn8.lib" `
            -DBOOST_ROOT="$boostPath" `
            -DOPENSSL_ROOT_DIR="$opensslPath" `
            -DCMAKE_BUILD_TYPE=${{ github.event.inputs.build_type }}

          # è·å–è§£å†³æ–¹æ¡ˆè·¯å¾„
          $slnPath = Get-ChildItem -Path . -Filter "*.sln" | Select-Object -First 1 -ExpandProperty FullName
          echo "SLN_PATH=$slnPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "âœ… ç”Ÿæˆè§£å†³æ–¹æ¡ˆï¼š$slnPath"
        shell: pwsh

      # 5. ä½¿ç”¨MSBuildç¼–è¯‘x64ä½äº§ç‰©
      - name: ç¼–è¯‘x64è§£å†³æ–¹æ¡ˆ
        run: |
          $slnPath = "${{ steps.cmake-config.outputs.SLN_PATH }}"
          $buildType = "${{ github.event.inputs.build_type }}"

          # åŠ è½½VS2022ç¯å¢ƒï¼ˆç¡®ä¿msbuildå¯ç”¨ï¼‰
          & "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\VsDevCmd.bat" -arch=x64 -host_arch=x64 | Out-Null

          # å¤šçº¿ç¨‹ç¼–è¯‘ï¼ˆ/mï¼‰å¹¶å®‰è£…
          msbuild "$slnPath" `
            /p:Configuration="$buildType" `
            /p:Platform="x64" `
            /t:INSTALL `
            /m `
            /nologo `
            /clp:ErrorsOnly;WarningsOnly

          Write-Host "âœ… ç¼–è¯‘å®Œæˆï¼Œäº§ç‰©è·¯å¾„ï¼šazertothcore/install/bin"
        shell: pwsh

      # 6. éªŒè¯äº§ç‰©ä¸ºx64æ¶æ„
      - name: éªŒè¯exeæ¶æ„ï¼ˆx64ï¼‰
        run: |
          # åŠ è½½VSå·¥å…·ï¼ˆå«dumpbinï¼‰
          & "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\Tools\VsDevCmd.bat" -arch=x64 | Out-Null

          # æ£€æŸ¥æ ¸å¿ƒå¯æ‰§è¡Œæ–‡ä»¶
          $exePaths = @(
            "azerothcore/install/bin/authserver.exe",
            "azerothcore/install/bin/worldserver.exe"
          )

          foreach ($exe in $exePaths) {
            if (-not (Test-Path $exe)) {
              Write-Error "âŒ æœªæ‰¾åˆ°äº§ç‰©ï¼š$exe"
              exit 1
            }
            # éªŒè¯æ˜¯å¦ä¸ºx64æ¶æ„ï¼ˆ8664å¯¹åº”x64ï¼‰
            $output = dumpbin /headers $exe | Select-String "machine"
            if ($output -notmatch "8664") {
              Write-Error "âŒ $exe ä¸æ˜¯x64æ¶æ„ï¼š$output"
              exit 1
            }
            Write-Host "âœ… éªŒè¯é€šè¿‡ï¼š$exeï¼ˆx64ï¼‰"
          }
        shell: pwsh

      # 7. æ‰“åŒ…äº§ç‰©
      - name: æ‰“åŒ…x64ä½æ‰§è¡Œæ–‡ä»¶
        id: package
        run: |
          $timestamp = Get-Date -Format "yyyyMMddHHmmss"
          $packageName = "acore-x64-${{ github.event.inputs.build_type }}-${timestamp}.zip"
          7z a -tzip $packageName .\azerothcore\install\*
          echo "PACKAGE_NAME=$packageName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "ğŸ“¦ æ‰“åŒ…å®Œæˆï¼š$packageName"
        shell: pwsh

      # 8. ä¸Šä¼ äº§ç‰©ä¸ºArtifact
      - name: ä¿å­˜ç¼–è¯‘äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.PACKAGE_NAME }}
          path: ${{ steps.package.outputs.PACKAGE_NAME }}
          retention-days: 7

      # 9. è¾“å‡ºç»“æœä¿¡æ¯
      - name: è¾“å‡ºæ„å»ºç»“æœ
        run: |
          Write-Host "::notice::âœ… æ„å»ºå®Œæˆï¼ˆx64ï¼‰"
          Write-Host "::notice::ğŸ“¦ äº§ç‰©åç§°ï¼š${{ steps.package.outputs.PACKAGE_NAME }}"
          Write-Host "::notice::ğŸ”¨ ç¼–è¯‘ç±»å‹ï¼š${{ github.event.inputs.build_type }}"
          Write-Host "::notice::ğŸ—“ï¸ æ—¶é—´ï¼š$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        shell: pwsh
