name: ç¼–è¯‘AzerothCoreï¼ˆWindows x86-64ï¼ŒVSè§£å†³æ–¹æ¡ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      acore_repo:
        description: "AzerothCoreä»“åº“åœ°å€"
        required: true
        default: "https://github.com/azerothcore/azerothcore-wotlk.git"
        type: string
      acore_branch:
        description: "AzerothCoreåˆ†æ”¯"
        required: true
        default: "master"
        type: string
      build_type:
        description: "ç¼–è¯‘ç±»å‹"
        required: true
        default: "RelWithDebInfo"
        type: choice
        options:
          - Debug
          - Release
          - RelWithDebInfo
          - MinSizeRel
  push:
    branches: ["main"]

jobs:
  build-with-vs:
    runs-on: windows-2022
    steps:
      - name: æ£€æŸ¥ç³»ç»Ÿæ¶æ„ï¼ˆx86-64ï¼‰
        run: |
          $arch = (Get-CimInstance Win32_OperatingSystem).OSArchitecture
          if ($arch -ne "64-bit") {
            Write-Error "âŒ ä»…æ”¯æŒx86-64æ¶æ„ï¼ˆå½“å‰ï¼š$archï¼‰"
            exit 1
          }
          Write-Host "âœ… ç¡®è®¤æ¶æ„ï¼šx86-64"
        shell: pwsh

      - name: å®‰è£…ä¾èµ–ï¼ˆVS2022 + å·¥å…·é“¾ï¼‰
        run: |
          # å®‰è£…ChocolateyåŒ…ç®¡ç†å™¨
          if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
            Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          }
          # å®‰è£…VS2022ï¼ˆå«C++æ¡Œé¢å¼€å‘ç»„ä»¶ï¼‰ã€CMakeã€ä¾èµ–åº“
          choco install -y git cmake 7zip visualstudio2022community --package-parameters "--installPath ""C:\Program Files\Microsoft Visual Studio\2022\Community"" --add Microsoft.VisualStudio.Workload.NativeDesktop --includeRecommended"
          choco install -y boost-msvc-14.3 mysql-connector-c++ openssl bzip2
          
          # æ·»åŠ VSå‘½ä»¤è¡Œå·¥å…·åˆ°ç¯å¢ƒå˜é‡ï¼ˆç¡®ä¿devenvå¯ç”¨ï¼‰
          $vsPath = "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE"
          echo "$vsPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "âœ… VSå‘½ä»¤è¡Œå·¥å…·è·¯å¾„ï¼š$vsPath"
        shell: pwsh

      - name: å®šä¹‰æ—¶é—´æˆ³å˜é‡
        id: timestamp
        run: |
          $timestamp = Get-Date -Format "yyyyMMddHHmmss"
          echo "TIMESTAMP=$timestamp" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
        shell: pwsh

      - name: å…‹éš†AzerothCoreä»“åº“
        run: |
          $repo = "${{ github.event.inputs.acore_repo || 'https://github.com/azerothcore/azerothcore-wotlk.git' }}"
          $branch = "${{ github.event.inputs.acore_branch || 'master' }}"
          Write-Host "ğŸ”§ å…‹éš†ä»“åº“ï¼š$repoï¼ˆåˆ†æ”¯ï¼š$branchï¼‰"
          git clone --depth 1 --branch $branch $repo azerothcore
          cd azerothcore
          git submodule update --init --recursive
        shell: pwsh

      - name: ç”ŸæˆVS2022 x64è§£å†³æ–¹æ¡ˆï¼ˆCMakeï¼‰
        id: generate-sln
        run: |
          $buildType = "${{ github.event.inputs.build_type || 'RelWithDebInfo' }}"
          # åˆ›å»ºæ„å»ºç›®å½•
          New-Item -Path azerothcore\build -ItemType Directory -Force | Out-Null
          cd azerothcore\build
          
          # ç”ŸæˆVS2022 x64è§£å†³æ–¹æ¡ˆï¼ˆ.slnæ–‡ä»¶ï¼‰
          cmake .. `
            -G "Visual Studio 17 2022" `  # ç”ŸæˆVS2022è§£å†³æ–¹æ¡ˆ
            -A x64 `                      # ç›®æ ‡æ¶æ„x86-64
            -DCMAKE_INSTALL_PREFIX=../install `
            -DBUILD_SHARED_LIBS=OFF `
            -DWITH_WARNINGS=1 `
            -DTOOLS_BUILD=all `
            -DSCRIPTS=static `
            -DMODULES=static `
            -DMySQL_INCLUDE_DIR="C:\Program Files\MySQL\MySQL Connector C++ 8.0\include" `
            -DMySQL_LIBRARY="C:\Program Files\MySQL\MySQL Connector C++ 8.0\lib64\mysqlcppconn8.lib"
          
          # è·å–ç”Ÿæˆçš„è§£å†³æ–¹æ¡ˆè·¯å¾„ï¼ˆé€šå¸¸ä¸º AzerothCore.slnï¼‰
          $slnPath = Get-ChildItem -Path . -Filter "*.sln" | Select-Object -First 1 -ExpandProperty FullName
          echo "SLN_PATH=$slnPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "âœ… ç”ŸæˆVSè§£å†³æ–¹æ¡ˆï¼š$slnPath"
        shell: pwsh

      - name: ç”¨VSç¼–è¯‘è§£å†³æ–¹æ¡ˆï¼ˆdevenv.comï¼‰
        run: |
          $buildType = "${{ github.event.inputs.build_type || 'RelWithDebInfo' }}"
          $slnPath = "${{ steps.generate-sln.outputs.SLN_PATH }}"
          
          # è°ƒç”¨VSå‘½ä»¤è¡Œå·¥å…·devenvç¼–è¯‘è§£å†³æ–¹æ¡ˆï¼ˆç­‰æ•ˆäºåœ¨VSä¸­æ‰“å¼€å¹¶ç”Ÿæˆï¼‰
          # æ ¼å¼ï¼šdevenv.com è§£å†³æ–¹æ¡ˆè·¯å¾„ /Build "é…ç½®|å¹³å°"
          devenv.com "$slnPath" /Build "${buildType}|x64" /Project INSTALL
          
          Write-Host "âœ… ç¼–è¯‘å®Œæˆï¼Œäº§ç‰©å·²å®‰è£…åˆ° azerothcore/install ç›®å½•"
        shell: pwsh

      - name: æ‰“åŒ…ç¼–è¯‘ç»“æœï¼ˆ7-Zipï¼‰
        id: package
        run: |
          $timestamp = "${{ steps.timestamp.outputs.TIMESTAMP }}"
          $packageName = "acore-build-vs-x64-${timestamp}.zip"
          7z a -tzip $packageName .\azerothcore\install\*
          $packageSize = [math]::Round((Get-Item $packageName).Length / 1MB, 2)
          echo "PACKAGE_NAME=$packageName" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          echo "PACKAGE_SIZE=${packageSize} MB" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "ğŸ“¦ æ‰“åŒ…å®Œæˆï¼š$packageNameï¼ˆå¤§å°ï¼š$packageSize MBï¼‰"
        shell: pwsh

      - name: è¾“å‡ºç»“æœåˆ°Annotations
        run: |
          Write-Error "::notice title=VSç¼–è¯‘ç»“æœ::" -ErrorAction Continue
          Write-Error "::notice::ğŸ“¦ äº§ç‰©åç§°ï¼š${{ steps.package.outputs.PACKAGE_NAME }}" -ErrorAction Continue
          Write-Error "::notice::ğŸ“Š äº§ç‰©å¤§å°ï¼š${{ steps.package.outputs.PACKAGE_SIZE }}" -ErrorAction Continue
          Write-Error "::notice::ğŸ”¨ ç¼–è¯‘ç±»å‹ï¼š${{ github.event.inputs.build_type || 'RelWithDebInfo' }}" -ErrorAction Continue
          Write-Error "::notice::ğŸ’» è§£å†³æ–¹æ¡ˆï¼š${{ steps.generate-sln.outputs.SLN_PATH }}" -ErrorAction Continue
          Write-Error "::notice::â° å®Œæˆæ—¶é—´ï¼š$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" -ErrorAction Continue
        shell: pwsh

      # ä¿å­˜äº§ç‰©ä¸ºArtifactï¼ˆå¯é€‰ï¼‰
      - name: ä¿å­˜äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.PACKAGE_NAME }}
          path: ${{ steps.package.outputs.PACKAGE_NAME }}
          retention-days: 7
